{% raw %}
<html>
 <head></head>
 <body>
  <div id="preamble">
   <div class="sectionbody">
    <h2 id="about_this_guide" class="discrete">About this guide</h2>
    <div class="paragraph">
     <p>This guide covers installing, configuring, securing, and operating the Kroxylicious Proxy in a non-Kubernetes environment. Refer to other Kroxylicious guides for information on running the proxy on Kubernetes using the Kroxylicious Operator, or for advanced topics such as plugin development.</p>
    </div>
   </div>
  </div>
  <div class="sect1">
   <h2 id="assembly-overview-proxy">1. Kroxylicious Proxy overview</h2>
   <div class="sectionbody">
    <div class="paragraph _abstract">
     <p>Kroxylicious is an Apache Kafka protocol-aware ("Layer 7") proxy designed to enhance Kafka-based systems. Through its filter mechanism it allows additional behavior to be introduced into a Kafka-based system without requiring changes to either your applications or the Kafka cluster itself. Built-in filters are provided as part of the solution.</p>
    </div>
    <div class="paragraph">
     <p>Functioning as an intermediary, the Kroxylicious mediates communication between a Kafka cluster and its clients. It takes on the responsibility of receiving, filtering, and forwarding messages.</p>
    </div>
    <div class="paragraph">
     <p>A Java API provides a convenient means for implementing custom logic within the proxy.</p>
    </div>
    <div class="ulist _additional-resources">
     <div class="title">Additional resources</div>
     <ul>
      <li>
       <p><a href="https://kafka.apache.org" target="_blank" rel="noopener">Apache Kafka website</a></p>
      </li>
     </ul>
    </div>
    <div class="sect2">
     <h3 id="con-proxy-overview-proxy">1.1. Why use proxies?</h3>
     <div class="paragraph">
      <p>Proxies are a powerful and flexible architectural pattern. For Kafka, they can be used to add functionality to Kafka clusters which is not available out-of-the-box with Apache Kafka. In an ideal world, such functionality would be implemented directly in Apache Kafka. But there are numerous practical reasons that can prevent this, for example:</p>
     </div>
     <div class="ulist">
      <ul>
       <li>
        <p>Organizations having very niche requirements which are unsuitable for implementation directly in Apache Kafka.</p>
       </li>
       <li>
        <p>Functionality which requires changes to Kafka’s public API and which the Apache Kafka project is unwilling to implement. This is the case for <a href="https://lists.apache.org/thread/x1p119hkpoy01vq9ck3d0ql67jtvm875">broker interceptors</a>, for example.</p>
       </li>
       <li>
        <p>Experimental functionality which might end up being implemented in Apache Kafka eventually. For example using Kroxylicious it’s easier to experiment with alternative transport protocols, such as Quic, or operating system APIs, such as io_uring, because there is already support for this in Netty, the networking framework on which Kroxylicious is built.</p>
       </li>
      </ul>
     </div>
     <div class="sect3">
      <h4 id="how_kroxylicious_works">1.1.1. How Kroxylicious works</h4>
      <div class="paragraph">
       <p>First let’s define the concepts in the landscape surrounding Kroxylicious.</p>
      </div>
      <div class="olist arabic">
       <ol class="arabic">
        <li>
         <p><em>Kafka Client</em>, or <em>Client</em> refers to any client application using a Kafka Client library to talk to a <strong>Kafka Cluster</strong>.</p>
        </li>
        <li>
         <p><em>Kafka Cluster</em> or <em>Cluster</em> refers to a cluster comprising one or more Kafka Brokers.</p>
        </li>
        <li>
         <p><em>Downstream</em> refers to the area between Kafka Client and Kroxylicious.</p>
        </li>
        <li>
         <p><em>Upstream</em> refers to the area between Kroxylicious and a Kafka Cluster.</p>
        </li>
       </ol>
      </div>
      <div class="imageblock">
       <div class="content">
        <img src="../images/diag-a2s-md5-00ea80ca071ece7ef3f5648aa70e594c.svg" alt="Diagram" width="702" height="448">
       </div>
       <div class="title">Figure 1. Kroxylicious landscape</div>
      </div>
      <div class="paragraph">
       <p>Now let’s define some concepts used within Kroxylicious itself.</p>
      </div>
      <div class="sect4">
       <h5 id="virtual_cluster">Virtual cluster</h5>
       <div class="paragraph">
        <p>The <em>Virtual Cluster</em> is the downstream representation of a Kafka Cluster. At the conceptual level, a Kafka Client connects to a Virtual Cluster. Kroxylicious proxies all communications made to the Virtual Cluster through to a (physical) Kafka Cluster, passing it through the <em>Filter Chain</em>.</p>
       </div>
      </div>
      <div class="sect4">
       <h5 id="virtual_cluster_gateway">Virtual cluster gateway</h5>
       <div class="paragraph">
        <p>Each virtual cluster has one or more dedicated gateways, which Kafka clients use to establish connections.</p>
       </div>
       <div class="paragraph">
        <p>Each gateway exposes a bootstrap endpoint, which the Kafka Client must specify in its configuration as the <a href="https://kafka.apache.org/documentation/#producerconfigs_bootstrap.servers"><code>bootstrap.servers</code></a> property.</p>
       </div>
       <div class="paragraph">
        <p>In addition to the bootstrap endpoint, the gateway automatically exposes broker endpoints. There is one broker endpoint for each broker of the physical cluster. When the Client connects to a broker endpoint, Kroxylicious proxies all communications to the corresponding broker of the (physical) Kafka Cluster.</p>
       </div>
       <div class="paragraph">
        <p>Kroxylicious automatically intercepts all the Kafka RPC responses that contain a broker address. It rewrites the address so that it refers to the corresponding broker endpoint of the Virtual Cluster. This means when the Kafka Client goes to connect to, say broker 0, it does so through the Virtual Cluster.</p>
       </div>
       <div class="paragraph">
        <p>Defining multiple gateways for a virtual cluster is useful when exposing it across different network segments. For example, in Kubernetes, you might configure one gateway for on-cluster traffic and another for off-cluster traffic.</p>
       </div>
      </div>
      <div class="sect4">
       <h5 id="target_cluster">Target cluster</h5>
       <div class="paragraph">
        <p>The <em>Target Cluster</em> is the definition of physical Kafka Cluster within the Kroxylicious itself.</p>
       </div>
       <div class="paragraph">
        <p>A <em>Virtual Cluster</em> has exactly one <em>Target Cluster</em>.</p>
       </div>
       <div class="paragraph">
        <p>There can be a <em>one-to-one</em> relationship between Virtual Clusters and Target Clusters. The other possibility is <em>many-to-one</em>, where many Virtual Clusters point to the same Target Cluster. The many-to-one pattern is exploited by filters such as the <a href="multi-tenancy/proc-multi-tenancy.html#proc-multi-tenancy-proxy">Multi-tenancy</a> filter.</p>
       </div>
       <div class="imageblock">
        <div class="content">
         <img src="../images/diag-a2s-md5-611ce7489f526bebfad718319d9476e4.svg" alt="Diagram" width="792" height="288">
        </div>
        <div class="title">Figure 2. One-to-One relationship between Virtual Cluster and Target Cluster</div>
       </div>
       <div class="imageblock">
        <div class="content">
         <img src="../images/diag-a2s-md5-f625626720a26ee2e8595af644c5cef6.svg" alt="Diagram" width="792" height="416">
        </div>
        <div class="title">Figure 3. Many-to-one between Virtual Cluster and Target Cluster</div>
       </div>
       <div class="paragraph">
        <p>A one-to-many pattern, where one Virtual Cluster points to many Target Clusters (providing amalgamation), is not a supported use-case.</p>
       </div>
      </div>
      <div class="sect4">
       <h5 id="filter_chain">Filter chain</h5>
       <div class="paragraph">
        <p>A <em>Filter Chain</em> consists of an <strong>ordered list</strong> of pluggable <em>protocol filters</em>.</p>
       </div>
       <div class="paragraph">
        <p>A <em>protocol filter</em> implements some logic for intercepting, inspecting and/or manipulating Kafka protocol messages. Kafka protocol requests (such as <code>Produce</code> requests) pass sequentially through each of the protocol filters in the chain, beginning with the 1st filter in the chain and then following with the subsequent filters, before being forwarded to the broker.</p>
       </div>
       <div class="paragraph">
        <p>When the broker returns a response (such as a <code>Produce</code> response) the protocol filters in the chain are invoked in the reverse order (that is, beginning with the nth filter in the chain, then the n-1th and so on) with each having the opportunity to inspect and/or manipulating the response. Eventually a response is returned to the client.</p>
       </div>
       <div class="paragraph">
        <p>The description above describes only the basic capabilities of the protocol filter. Richer features of filters are described later.</p>
       </div>
       <div class="imageblock">
        <div class="content">
         <img src="../images/diag-a2s-md5-0a81c031d02fc4fdea01a37bc2114bcc.svg" alt="Diagram" width="1089" height="368">
        </div>
        <div class="title">Figure 4. Illustration of a request and response being manipulated by filters in a chain</div>
       </div>
       <div class="paragraph">
        <p>As mentioned above, Kroxylicious takes the responsibility to rewrite the Kafka RPC responses that carry broker address information so that they reflect the broker addresses exposed by the Virtual Cluster. These are the <a href="https://kafka.apache.org/protocol.html#The_Messages_Metadata"><code>Metadata</code></a>, <a href="https://kafka.apache.org/protocol.html#The_Messages_DescribeCluster"><code>DescribeCluster</code></a> and <a href="https://kafka.apache.org/protocol.html#The_Messages_FindCoordinator"><code>FindCoordinator</code></a> responses. This processing is entirely transparent to the work of the protocol filters. <em>Filter authors</em> are free to write their own filters that intercept these responses too.</p>
       </div>
      </div>
      <div class="sect4">
       <h5 id="filter_composition">Filter composition</h5>
       <div class="paragraph">
        <p>An important principal for the protocol filter API is that filters should <em>compose</em> nicely. That means that filters generally don’t know what other filters might be present in the chain, and what they might be doing to messages. When a filter forwards a request or response it doesn’t know whether the message is being sent to the next filter in the chain, or straight back to the client.</p>
       </div>
       <div class="paragraph">
        <p>Such composition is important because it means a <em>proxy user</em> can configure multiple filters (possibly written by several <em>filter authors</em>) and expect to get the combined effect of all of them.</p>
       </div>
       <div class="paragraph">
        <p>It’s never quite that simple, of course. In practice they will often need to understand what each filter does in some detail in order to be able to operate their proxy properly, for example by understanding whatever metrics each filter is emitting.</p>
       </div>
      </div>
     </div>
     <div class="sect3">
      <h4 id="implementation">1.1.2. Implementation</h4>
      <div class="paragraph">
       <p>The proxy is written in Java, on top of <a href="https://netty.io">Netty</a>. The usual <a href="https://netty.io/4.1/api/io/netty/channel/ChannelHandler.html"><code>ChannelHandlers</code></a> provided by the Netty project are used where appropriate (e.g. SSL support uses <a href="https://netty.io/4.1/api/io/netty/handler/ssl/SslHandler.html"><code>SslHandler</code></a>), and Kroxylicious provides Kafka-specific handlers of its own.</p>
      </div>
      <div class="paragraph">
       <p>The Kafka-aware parts use the Apache Kafka project’s own classes for serialization and deserialization.</p>
      </div>
      <div class="paragraph">
       <p>Protocol filters get executed using a handler-per-filter model.</p>
      </div>
     </div>
     <div class="sect3">
      <h4 id="deployment_topologies">1.1.3. Deployment topologies</h4>
      <div class="paragraph">
       <p>The proxy supports a range of possible deployment topologies. Which style is used depends on what the proxy is meant to <em>achieve</em>, architecturally speaking. Broadly speaking a proxy instance can be deployed:</p>
      </div>
      <div class="dlist">
       <dl>
        <dt class="hdlist1">As a forward proxy</dt>
        <dd>
         <p>Proxying the access of one or more clients to a particular cluster/broker that might also accessible (to other clients) directly.</p>
         <div class="paragraph">
          <p>Topic-level encryption provides one example use case for a forward proxy-style deployment. This might be applicable when using clients that don’t support interceptors, or if an organization wants to apply the same encryption policy in a single place, securing access to the keys within their network.</p>
         </div>
        </dd>
        <dt class="hdlist1">As a reverse proxy</dt>
        <dd>
         <p>Proxying access for all clients trying to reach a particular cluster/broker.</p>
         <div class="paragraph">
          <p>Transparent multi-tenancy provides an example use case for a reverse proxy. While Apache Kafka itself has some features that enable multi-tenancy, they rely on topic name prefixing as the primary mechanism for ensuring namespace isolation. Tenants have to adhere to the naming policy and know they’re a tenant of a larger shared cluster.</p>
         </div>
         <div class="paragraph">
          <p><em>Transparent</em> multi-tenancy means each tenant has the illusion of having their own cluster, with almost complete freedom over topic and group naming, while still actually sharing a cluster.</p>
         </div>
        </dd>
       </dl>
      </div>
      <div class="paragraph">
       <p>We can further classify deployment topologies in how many proxy instances are used. For example:</p>
      </div>
      <div class="ulist">
       <ul>
        <li>
         <p>Single proxy instance (sidecar)</p>
        </li>
        <li>
         <p>Proxy pool</p>
        </li>
       </ul>
      </div>
     </div>
    </div>
    <div class="sect2">
     <h3 id="con-api-compatibilityproxy">1.2. Compatibility</h3>
     <div class="sect3">
      <h4 id="con-api-compatibility-apiproxy">1.2.1. APIs</h4>
      <div class="paragraph">
       <p>Kroxylicious follows <a href="https://semver.org/#semantic-versioning-200">Semantic Versioning</a> rules. While we are still in the initial development phase (denoted by a major version 0), we still take API compatibility very seriously. We aim to provide at least two minor releases between deprecation and the removal of that deprecated item.</p>
      </div>
      <div class="paragraph">
       <p>We also consider our configuration file syntax a public API (though not the Java model backing it). As such, the syntax follows the same Semantic Versioning and deprecation rules.</p>
      </div>
      <div class="paragraph">
       <p>Kubernetes custom resources are a public API, and we are making every effort to evolve Kroxylicious custom resources in line with <a href="https://kubernetes.io/docs/tasks/extend-kubernetes/custom-resources/custom-resource-definition-versioning/">Kubernetes best practices</a>. Kubernetes resources have their own versioning scheme, which is independent of the Kroxylicious proxy service version. As a result, we may reach version 1.0.0 of Kroxylicious while still using alpha or beta versions of the custom resources.</p>
      </div>
      <div class="sect4">
       <h5 id="con-api-compatibility-third-partyproxy">Third-party plugins</h5>
       <div class="paragraph">
        <p>Kroxylicious supports loading third-party plugins to extend the core functionality of the project. While these plugins are configured and loaded as first-class entities within Kroxylicious, we cannot guarantee the compatibility of their APIs or configuration properties.</p>
       </div>
       <div class="paragraph">
        <p>We do however hold filters and plugins provided by the project to the same standards as the rest of the public API.</p>
       </div>
      </div>
     </div>
     <div class="sect3">
      <h4 id="con-api-compatibility-wire-protocolproxy">1.2.2. Wire protocol</h4>
      <div class="paragraph">
       <p>Kroxylicious offers the same backwards and forwards compatibility guarantees as <a href="https://kafka.apache.org/protocol#protocol_compatibility">Apache Kafka</a>. We support the same range of client and broker versions as the official Apache Kafka Java client.</p>
      </div>
     </div>
    </div>
   </div>
  </div>
  <div class="sect1">
   <h2 id="assembly-configuring-proxy-proxy">2. Configuring proxies</h2>
   <div class="sectionbody">
    <div class="paragraph _abstract">
     <p>Fine-tune your deployment by configuring proxies to include additional features according to your specific requirements.</p>
    </div>
    <div class="sect2">
     <h3 id="con-configuration-outline-proxy">2.1. Outline of a Kroxylicious configuration</h3>
     <div class="paragraph _abstract">
      <p>The following example shows the overall outline of a simple Kroxylicious configuration. While not complete (as indicated by <code># …​</code>), it illustrates the essential structure.</p>
     </div>
     <div id="con-basic-structure-proxy" class="listingblock">
      <div class="title">Basic outline of a Kroxylicious configuration</div>
      <div class="content">
       <pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">filterDefinitions</span>: <i class="conum" data-value="1"></i><b>(1)</b>
  - <span class="string"><span class="content">name: example </span></span><i class="conum" data-value="2"></i><b>(2)</b>
    <span class="key">type</span>: <span class="string"><span class="content">org.example.filter.Example </span></span><i class="conum" data-value="3"></i><b>(3)</b>
    <span class="key">config</span>: <i class="conum" data-value="4"></i><b>(4)</b>
      <span class="comment"># ...</span>
<span class="key">defaultFilters</span>: <i class="conum" data-value="5"></i><b>(5)</b>
  - <span class="string"><span class="content">example</span></span>
<span class="key">virtualClusters</span>: <i class="conum" data-value="6"></i><b>(6)</b>
  - <span class="string"><span class="content">name: my-cluster-proxy</span></span>
    <span class="key">targetCluster</span>: <i class="conum" data-value="7"></i><b>(7)</b>
      <span class="comment"># ...</span>
    <span class="key">gateways</span>: <i class="conum" data-value="8"></i><b>(8)</b>
    - <span class="string"><span class="content">name: ...</span></span>
      <span class="comment"># ...</span>
<span class="comment"># ...</span></code></pre>
      </div>
     </div>
     <div class="colist arabic">
      <table>
       <tbody>
        <tr>
         <td><i class="conum" data-value="1"></i><b>1</b></td>
         <td>A list of named filter definitions.</td>
        </tr>
        <tr>
         <td><i class="conum" data-value="2"></i><b>2</b></td>
         <td>A filter definition called <code>example</code>. The definitions must each have a unique name.</td>
        </tr>
        <tr>
         <td><i class="conum" data-value="3"></i><b>3</b></td>
         <td>The name of the filter class implementation for the <code>example</code> filter. Required.</td>
        </tr>
        <tr>
         <td><i class="conum" data-value="4"></i><b>4</b></td>
         <td>The configuration for the <code>example</code> filter instance. Usually required for non-trivial filters.</td>
        </tr>
        <tr>
         <td><i class="conum" data-value="5"></i><b>5</b></td>
         <td>A list of default filters. It’s possible to override this list at the virtual cluster level.</td>
        </tr>
        <tr>
         <td><i class="conum" data-value="6"></i><b>6</b></td>
         <td>List of virtual clusters specified by name, with cluster-specific configurations.</td>
        </tr>
        <tr>
         <td><i class="conum" data-value="7"></i><b>7</b></td>
         <td>Configuration of the actual Kafka cluster that is proxied by the 'my-cluster-proxy' virtual cluster.</td>
        </tr>
        <tr>
         <td><i class="conum" data-value="8"></i><b>8</b></td>
         <td>Configuration of the gateways for this virtual cluster.</td>
        </tr>
       </tbody>
      </table>
     </div>
    </div>
    <div class="sect2">
     <h3 id="ref-configuring-filters-proxy">2.2. Defining filters</h3>
     <div class="paragraph">
      <p>Filters in Kroxylicious can be defined globally with <code>filterDefinitions</code>, applied by default using <code>defaultFilters</code>, or customized for specific virtual clusters. The following example shows how these elements work together flexibly:</p>
     </div>
     <div id="con-filterDefinitions-defaultFilters-proxy" class="listingblock">
      <div class="title">Example configuration showing global filter definitions applied as defaults and to virtual cluster</div>
      <div class="content">
       <pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">filterDefinitions</span>:
  - <span class="string"><span class="content">name: encryption</span></span>
    <span class="key">type</span>: <span class="string"><span class="content">RecordEncryption</span></span>
    <span class="key">config</span>:
      <span class="comment"># ...</span>
  - <span class="string"><span class="content">name: validation</span></span>
    <span class="key">type</span>: <span class="string"><span class="content">RecordValidation</span></span>
    <span class="key">config</span>:
      <span class="comment"># ...</span>
  - <span class="string"><span class="content">name: special-encryption</span></span>
    <span class="key">type</span>: <span class="string"><span class="content">RecordEncryption</span></span>
    <span class="key">config</span>:
      <span class="comment"># ...</span>
<span class="key">defaultFilters</span>:
  - <span class="string"><span class="content">validation</span></span>
  - <span class="string"><span class="content">encryption</span></span>
<span class="key">virtualClusters</span>:
  - <span class="string"><span class="content">name: my-proxy-with-default-filters</span></span>
    <span class="comment"># ...</span>
  - <span class="string"><span class="content">name: my-proxy-with-custom-filters</span></span>
    <span class="key">filters</span>:
      - <span class="string"><span class="content">validation</span></span>
      - <span class="string"><span class="content">special-encryption</span></span>
    <span class="comment"># ...</span>
<span class="comment"># ...</span></code></pre>
      </div>
     </div>
     <div class="ulist">
      <ul>
       <li>
        <p>The order of definitions in <code>filterDefinitions</code> does not matter.</p>
       </li>
       <li>
        <p>Each filter definition in <code>filterDefinitions</code> must have a unique <code>name</code>, but you can have multiple definitions with the same type and different configurations (as with <code>encryption</code> and <code>special-encryption</code> in the example).</p>
       </li>
       <li>
        <p>The order of <code>defaultFilters</code> determines the sequence in which the filters are applied to incoming client requests. In the example, records are first validated and then encrypted.</p>
       </li>
       <li>
        <p>The <code>defaultFilters</code> are used for all virtual clusters which don’t define their own <code>filters</code>, such as <code>my-proxy-with-default-filters</code>.</p>
       </li>
       <li>
        <p>The <code>defaultFilters</code> property is optional. It is useful when all virtual clusters must use the same filters. There’s no need to specify it if all virtual clusters have specific <code>filters</code> defined.</p>
       </li>
       <li>
        <p>When a virtual cluster has defined <code>filters</code>, like <code>my-proxy-with-custom-filters</code>, then those filters are used instead of the <code>defaultFilters</code>.</p>
       </li>
       <li>
        <p>When using <code>defaultFilters</code> or a virtual cluster’s <code>filters</code> to reference a filter definition, you must define a filter with the corresponding name in <code>filterDefinitions</code>.</p>
       </li>
      </ul>
     </div>
    </div>
    <div class="sect2">
     <h3 id="con-configuring-virtual-clusters-proxy">2.3. Configuring virtual clusters</h3>
     <div class="paragraph _abstract">
      <p>A Kafka cluster is represented by the proxy as a virtual cluster. Clients communicate with the virtual cluster rather than the actual cluster. When Kroxylicious is deployed, it includes configuration to create virtual clusters.</p>
     </div>
     <div class="paragraph">
      <p>A virtual cluster has exactly one target cluster, but many virtual clusters can target the same cluster. Each virtual cluster targets a single listener on the target cluster, so multiple listeners on the Kafka side are represented as multiple virtual clusters by the proxy. Clients connect to a virtual cluster using a <code>bootstrapServers</code> address. The virtual cluster has a bootstrap address that maps to each broker in the target cluster. When a client connects to the proxy, communication is proxied to the target broker by rewriting the address. Responses back to clients are rewritten to reflect the appropriate network addresses of the virtual clusters.</p>
     </div>
     <div class="paragraph">
      <p>You can secure virtual cluster connections from clients and to target clusters.</p>
     </div>
     <div class="paragraph">
      <p>Kroxylicious accepts keys and certificates in PEM (Privacy Enhanced Mail), PKCS #12 (Public-Key Cryptography Standards), or JKS (Java KeyStore) keystore format.</p>
     </div>
    </div>
    <div class="sect2">
     <h3 id="con-configuring-vc-gateways-proxy">2.4. Configuring virtual cluster gateways</h3>
     <div class="paragraph _abstract">
      <p>Clients connect to a virtual cluster gateway. Each gateway provides a bootstrap address for the initial connection. The gateway also facilitates communication between clients and proxied brokers. This can be implemented in two ways:</p>
     </div>
     <div class="dlist">
      <dl>
       <dt class="hdlist1">Port Identifies Node</dt>
       <dd>
        <p>The gateway binds separate ports—one for each broker as well as an additional one for the bootstrap address. Clients make connections to the different port numbers to interact with each broker.</p>
       </dd>
       <dt class="hdlist1">SNI Host Identifies Node</dt>
       <dd>
        <p>The gateway assigns a unique hostname to each broker. Clients make connections to these distinct hostnames to interact with the respective brokers. The gateway uses SNI (Server Name Indication) to identify the target broker for the client’s connection.</p>
       </dd>
      </dl>
     </div>
     <div class="admonitionblock important">
      <table>
       <tbody>
        <tr>
         <td class="icon"><i class="fa icon-important" title="Important"></i></td>
         <td class="content">You must make sure that the gateway’s bootstrap address and generated broker addresses are resolvable and routable by the Kafka Client. You must also make sure firewall rules permit traffic to required port numbers.</td>
        </tr>
       </tbody>
      </table>
     </div>
     <div class="sect3">
      <h4 id="port_identifies_node">2.4.1. Port Identifies Node</h4>
      <div class="paragraph">
       <p>In the Port Identifies Node scheme, the virtual cluster opens a separate port for each proxied broker in addition to a separate port for the bootstrap.</p>
      </div>
      <div class="paragraph">
       <p>By default, this scheme assumes that the target cluster comprises three nodes with broker ids 0..2. If this is inadequate, additional configuration can be provided describing the broker topology of the target broker.</p>
      </div>
      <div class="paragraph">
       <p>This scheme can be used with both plain and TLS downstream connections.</p>
      </div>
      <div class="paragraph">
       <p>This scheme works best with straightforward configurations where the target cluster uses a known minimum broker ID and uses stable sets of broker IDs. For more complex cases, it is recommended to use the SNI Host Identifies Node scheme.</p>
      </div>
      <div class="admonitionblock important">
       <table>
        <tbody>
         <tr>
          <td class="icon"><i class="fa icon-important" title="Important"></i></td>
          <td class="content">When using this scheme, you have the responsibility to avoid port number collision. Ensure that each gateway has its own range of port numbers and these do not overlap with the range used by another gateway, or the gateway of another virtual cluster.</td>
         </tr>
        </tbody>
       </table>
      </div>
      <div id="con-configuring-vc-gateways-port-identifies-node-proxy" class="listingblock">
       <div class="title">Example Port Identifies Node configuration</div>
       <div class="content">
        <pre class="CodeRay highlight"><code data-lang="yaml"><span class="comment"># ...</span>
<span class="key">virtualClusters</span>:
  - <span class="string"><span class="content">name: my-cluster-proxy</span></span>
    <span class="comment"># ...</span>
    <span class="key">gateways</span>:
    - <span class="string"><span class="content">name: mygateway</span></span>
      <span class="key">portIdentifiesNode</span>:
        <span class="key">bootstrapAddress</span>: <span class="string"><span class="content">localhost:9192</span></span> <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="comment"># ...</span>
<span class="comment"># ...</span></code></pre>
       </div>
      </div>
      <div class="colist arabic">
       <table>
        <tbody>
         <tr>
          <td><i class="conum" data-value="1"></i><b>1</b></td>
          <td>The bootstrap address used by Kafka clients.</td>
         </tr>
        </tbody>
       </table>
      </div>
      <div class="paragraph">
       <p>With the example configuration above, the gateway exposes a target cluster of up to three brokers with node ids <code>0</code>, <code>1</code>, <code>2</code>. The advertised address is defaulted to that of the bootstrap host name. Port numbers are assigned sequentially beginning at bootstrap port number + 1.</p>
      </div>
      <div class="paragraph">
       <p>The gateway exposes the following three broker addresses:</p>
      </div>
      <table class="tableblock frame-all grid-all stretch">
       <colgroup>
        <col style="width: 50%;">
        <col style="width: 50%;">
       </colgroup>
       <thead>
        <tr>
         <th class="tableblock halign-left valign-top">Node Id</th>
         <th class="tableblock halign-left valign-top">Broker Address</th>
        </tr>
       </thead>
       <tbody>
        <tr>
         <td class="tableblock halign-left valign-top">
          <p class="tableblock">0</p>
         </td>
         <td class="tableblock halign-left valign-top">
          <p class="tableblock">localhost:9193</p>
         </td>
        </tr>
        <tr>
         <td class="tableblock halign-left valign-top">
          <p class="tableblock">1</p>
         </td>
         <td class="tableblock halign-left valign-top">
          <p class="tableblock">localhost:9194</p>
         </td>
        </tr>
        <tr>
         <td class="tableblock halign-left valign-top">
          <p class="tableblock">2</p>
         </td>
         <td class="tableblock halign-left valign-top">
          <p class="tableblock">localhost:9195</p>
         </td>
        </tr>
       </tbody>
      </table>
      <div class="listingblock">
       <div class="title">Example Port Identifies Node configuration with customized broker address</div>
       <div class="content">
        <pre class="CodeRay highlight"><code data-lang="yaml"><span class="comment"># ...</span>
<span class="key">virtualClusters</span>:
  - <span class="string"><span class="content">name: my-cluster-proxy</span></span>
    <span class="comment"># ...</span>
    <span class="key">gateways</span>:
    - <span class="string"><span class="content">name: mygateway</span></span>
      <span class="key">portIdentifiesNode</span>:
        <span class="key">bootstrapAddress</span>: <span class="string"><span class="content">localhost:9192 </span></span><i class="conum" data-value="1"></i><b>(1)</b>
        <span class="key">advertisedBrokerAddressPattern</span>: <span class="string"><span class="content">mycluster.example.com </span></span><i class="conum" data-value="2"></i><b>(2)</b>
        <span class="key">brokerStartPort</span>: <span class="string"><span class="content">9200</span></span> <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="comment"># ...</span>
<span class="comment"># ...</span></code></pre>
       </div>
      </div>
      <div class="colist arabic">
       <table>
        <tbody>
         <tr>
          <td><i class="conum" data-value="1"></i><b>1</b></td>
          <td>The bootstrap address used by Kafka clients.</td>
         </tr>
         <tr>
          <td><i class="conum" data-value="2"></i><b>2</b></td>
          <td>(Optional) The advertised broker address pattern used to form broker addresses. If not defined, it defaults to the hostname part of the bootstrap address.</td>
         </tr>
         <tr>
          <td><i class="conum" data-value="3"></i><b>3</b></td>
          <td>(Optional) The starting number for the broker port range. Defaults to the port of the bootstrap address plus 1.</td>
         </tr>
        </tbody>
       </table>
      </div>
      <div class="paragraph">
       <p>With the example configuration above, the gateway exposes a target cluster of up to three brokers with node ids <code>0</code>, <code>1</code>, <code>2</code>. The advertised broker address is defined as <code>mycluster.example.com</code>. Port numbers are assigned sequentially beginning at <code>9200</code>.</p>
      </div>
      <div class="paragraph">
       <p>The gateway exposes the following three broker addresses:</p>
      </div>
      <table class="tableblock frame-all grid-all stretch">
       <colgroup>
        <col style="width: 50%;">
        <col style="width: 50%;">
       </colgroup>
       <thead>
        <tr>
         <th class="tableblock halign-left valign-top">Node Id</th>
         <th class="tableblock halign-left valign-top">Broker Address</th>
        </tr>
       </thead>
       <tbody>
        <tr>
         <td class="tableblock halign-left valign-top">
          <p class="tableblock">0</p>
         </td>
         <td class="tableblock halign-left valign-top">
          <p class="tableblock">mycluster.example.com:9200</p>
         </td>
        </tr>
        <tr>
         <td class="tableblock halign-left valign-top">
          <p class="tableblock">1</p>
         </td>
         <td class="tableblock halign-left valign-top">
          <p class="tableblock">mycluster.example.com:9201</p>
         </td>
        </tr>
        <tr>
         <td class="tableblock halign-left valign-top">
          <p class="tableblock">2</p>
         </td>
         <td class="tableblock halign-left valign-top">
          <p class="tableblock">mycluster.example.com:9203</p>
         </td>
        </tr>
       </tbody>
      </table>
      <div class="listingblock">
       <div class="title">Example Port Identifies Node configuration with customized node ranges</div>
       <div class="content">
        <pre class="CodeRay highlight"><code data-lang="yaml"><span class="comment"># ...</span>
<span class="key">virtualClusters</span>:
  - <span class="string"><span class="content">name: my-cluster-proxy</span></span>
    <span class="comment"># ...</span>
    <span class="key">gateways</span>:
    - <span class="string"><span class="content">name: mygateway</span></span>
      <span class="key">portIdentifiesNode</span>:
        <span class="key">bootstrapAddress</span>: <span class="string"><span class="content">localhost:9192 </span></span><i class="conum" data-value="1"></i><b>(1)</b>
        <span class="key">advertisedBrokerAddressPattern</span>: <span class="string"><span class="content">mycluster.example.com </span></span><i class="conum" data-value="2"></i><b>(2)</b>
        <span class="key">nodeIdRanges</span>: <i class="conum" data-value="3"></i><b>(3)</b>
        - <span class="string"><span class="content">name: mixed</span></span>
          <span class="key">start</span>: <span class="string"><span class="content">1</span></span>
          <span class="key">end</span>: <span class="string"><span class="content">3</span></span>
        - <span class="string"><span class="content">name: brokers</span></span>
          <span class="key">start</span>: <span class="string"><span class="content">100</span></span>
          <span class="key">end</span>: <span class="string"><span class="content">103</span></span>

    <span class="comment"># ...</span>
<span class="comment"># ...</span></code></pre>
       </div>
      </div>
      <div class="colist arabic">
       <table>
        <tbody>
         <tr>
          <td><i class="conum" data-value="1"></i><b>1</b></td>
          <td>The bootstrap address used by Kafka clients.</td>
         </tr>
         <tr>
          <td><i class="conum" data-value="2"></i><b>2</b></td>
          <td>(Optional) The advertised broker address pattern used to form broker addresses. If not defined, it defaults to the hostname part of the bootstrap address.</td>
         </tr>
         <tr>
          <td><i class="conum" data-value="3"></i><b>3</b></td>
          <td>(Optional) One or more node id ranges. If omitted, it defaults to a single range of node IDs 0..2 (inclusive).</td>
         </tr>
        </tbody>
       </table>
      </div>
      <div class="paragraph">
       <p>With the example configuration above, the gateway exposes a target cluster of up to six nodes with node ids <code>1..3</code> and <code>101..103</code>. The advertised broker address is defined as <code>mycluster.example.com</code>. Port numbers are assigned sequentially beginning at <code>9193</code> (bootstrap port number + 1).</p>
      </div>
      <div class="paragraph">
       <p>The gateway exposes the following six broker addresses:</p>
      </div>
      <table class="tableblock frame-all grid-all stretch">
       <colgroup>
        <col style="width: 50%;">
        <col style="width: 50%;">
       </colgroup>
       <thead>
        <tr>
         <th class="tableblock halign-left valign-top">Node Id</th>
         <th class="tableblock halign-left valign-top">Broker Address</th>
        </tr>
       </thead>
       <tbody>
        <tr>
         <td class="tableblock halign-left valign-top">
          <p class="tableblock">1</p>
         </td>
         <td class="tableblock halign-left valign-top">
          <p class="tableblock">mycluster.example.com:9193</p>
         </td>
        </tr>
        <tr>
         <td class="tableblock halign-left valign-top">
          <p class="tableblock">2</p>
         </td>
         <td class="tableblock halign-left valign-top">
          <p class="tableblock">mycluster.example.com:9194</p>
         </td>
        </tr>
        <tr>
         <td class="tableblock halign-left valign-top">
          <p class="tableblock">3</p>
         </td>
         <td class="tableblock halign-left valign-top">
          <p class="tableblock">mycluster.example.com:9195</p>
         </td>
        </tr>
        <tr>
         <td class="tableblock halign-left valign-top">
          <p class="tableblock">101</p>
         </td>
         <td class="tableblock halign-left valign-top">
          <p class="tableblock">mycluster.example.com:9196</p>
         </td>
        </tr>
        <tr>
         <td class="tableblock halign-left valign-top">
          <p class="tableblock">102</p>
         </td>
         <td class="tableblock halign-left valign-top">
          <p class="tableblock">mycluster.example.com:9197</p>
         </td>
        </tr>
        <tr>
         <td class="tableblock halign-left valign-top">
          <p class="tableblock">103</p>
         </td>
         <td class="tableblock halign-left valign-top">
          <p class="tableblock">mycluster.example.com:9198</p>
         </td>
        </tr>
       </tbody>
      </table>
      <div class="paragraph">
       <p>The <code>advertisedBrokerAddressPattern</code> configuration parameter accepts the <code>$(nodeId)</code> replacement token, which is optional. If included, <code>$(nodeId)</code> is replaced by the broker’s <a href="https://kafka.apache.org/documentation/#brokerconfigs_node.id"><code>node.id</code></a> (or <a href="https://kafka.apache.org/documentation/#brokerconfigs_broker.id"><code>broker.id</code></a>) in the target cluster.</p>
      </div>
     </div>
     <div class="sect3">
      <h4 id="con-configuring-vc-gateways-snihost-identifies-node-proxy">2.4.2. SNI Host Identifies Node</h4>
      <div class="paragraph">
       <p>In the SNI Host Identifies Node scheme, unique broker hostnames are used to know where to route the traffic. As this scheme relies on SNI (Server Name Indication), which is a TLS extension, TLS connections are required. It cannot be used with plain text connections.</p>
      </div>
      <div class="paragraph">
       <p>In this scheme, you can either share the port across multiple virtual cluster gateways or assign a separate port for each virtual cluster gateway. However, you cannot use a port that is already assigned to a virtual cluster gateway using the Port Identifies Node scheme.</p>
      </div>
      <div class="admonitionblock important">
       <table>
        <tbody>
         <tr>
          <td class="icon"><i class="fa icon-important" title="Important"></i></td>
          <td class="content">When using this scheme, you have the responsibility to make sure that DNS for bootstrap and brokers resolve to an IP address that is routed to the proxy. Wildcard DNS is one way to achieve this.</td>
         </tr>
        </tbody>
       </table>
      </div>
      <div class="listingblock">
       <div class="title">Example SNI Host Identifies Node configuration</div>
       <div class="content">
        <pre class="CodeRay highlight"><code data-lang="yaml"><span class="comment"># ...</span>
<span class="key">virtualClusters</span>:
  - <span class="string"><span class="content">name: my-cluster-proxy</span></span>
    <span class="comment"># ...</span>
    <span class="key">gateways</span>:
    - <span class="string"><span class="content">name: mygateway</span></span>
      <span class="key">sniHostIdentifiesNode</span>:
        <span class="key">bootstrapAddress</span>: <span class="string"><span class="content">mycluster.example.com:9192 </span></span><i class="conum" data-value="1"></i><b>(1)</b>
        <span class="key">advertisedBrokerAddressPattern</span>: <span class="string"><span class="content">mybroker-$(nodeId).mycluster.example.com </span></span><i class="conum" data-value="2"></i><b>(2)</b>
      <span class="key">tls</span>:
         <span class="key">key</span>: <span class="string"><span class="content">...</span></span> <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="comment"># ...</span>
<span class="comment"># ...</span></code></pre>
       </div>
      </div>
      <div class="colist arabic">
       <table>
        <tbody>
         <tr>
          <td><i class="conum" data-value="1"></i><b>1</b></td>
          <td>The bootstrap address used by Kafka clients.</td>
         </tr>
         <tr>
          <td><i class="conum" data-value="2"></i><b>2</b></td>
          <td>The advertised broker address pattern used to form broker addresses. It must include the placeholder $(nodeId) which is substituted for the node ID.</td>
         </tr>
         <tr>
          <td><i class="conum" data-value="3"></i><b>3</b></td>
          <td>TLS configuration.</td>
         </tr>
        </tbody>
       </table>
      </div>
      <div class="paragraph">
       <p>With the example configuration above, the gateway accepts all traffic on port 9192. Any TLS connections received with the SNI of <code>mycluster.example.com</code> are routed as bootstrap. Any connections received with SNI matching <code>mybroker-$(nodeId).mycluster.example.com</code> are routed to the upstream broker with the same node ID. The configuration exposes a target cluster with any number of brokers. It does not need prior knowledge of the node IDs used by the brokers.</p>
      </div>
      <div class="paragraph">
       <p>The gateway exposes the following broker addresses:</p>
      </div>
      <table class="tableblock frame-all grid-all stretch">
       <colgroup>
        <col style="width: 50%;">
        <col style="width: 50%;">
       </colgroup>
       <thead>
        <tr>
         <th class="tableblock halign-left valign-top">Node Id</th>
         <th class="tableblock halign-left valign-top">Broker Address</th>
        </tr>
       </thead>
       <tbody>
        <tr>
         <td class="tableblock halign-left valign-top">
          <p class="tableblock">0</p>
         </td>
         <td class="tableblock halign-left valign-top">
          <p class="tableblock">mybroker-0.mycluster.example.com:9192</p>
         </td>
        </tr>
        <tr>
         <td class="tableblock halign-left valign-top">
          <p class="tableblock">…​</p>
         </td>
         <td class="tableblock halign-left valign-top">
          <p class="tableblock">…​</p>
         </td>
        </tr>
        <tr>
         <td class="tableblock halign-left valign-top">
          <p class="tableblock"><em>n</em></p>
         </td>
         <td class="tableblock halign-left valign-top">
          <p class="tableblock">mybroker-<em>n</em>.mycluster.example.com:9192</p>
         </td>
        </tr>
       </tbody>
      </table>
      <div class="paragraph">
       <p>Both the <code>advertisedBrokerAddressPattern</code> and <code>bootstrapAddress</code> configuration parameters accept the <code>$(virtualClusterName)</code> replacement token, which is optional. If included, <code>$(virtualClusterName)</code> is replaced with the name of the gateway’s virtual cluster.</p>
      </div>
      <div class="listingblock">
       <div class="title">Example SNI Host Identifies Node configuration with customized advertised port</div>
       <div class="content">
        <pre class="CodeRay highlight"><code data-lang="yaml"><span class="comment"># ...</span>
<span class="key">virtualClusters</span>:
  - <span class="string"><span class="content">name: my-cluster-proxy</span></span>
    <span class="comment"># ...</span>
    <span class="key">gateways</span>:
    - <span class="string"><span class="content">name: mygateway</span></span>
      <span class="key">sniHostIdentifiesNode</span>:
        <span class="key">bootstrapAddress</span>: <span class="string"><span class="content">mycluster.example.com:9192 </span></span><i class="conum" data-value="1"></i><b>(1)</b>
        <span class="key">advertisedBrokerAddressPattern</span>: <span class="string"><span class="content">mybroker-$(nodeId).mycluster.example.com:443 </span></span><i class="conum" data-value="2"></i><b>(2)</b>
      <span class="key">tls</span>:
         <span class="key">key</span>: <span class="string"><span class="content">...</span></span> <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="comment"># ...</span>
<span class="comment"># ...</span></code></pre>
       </div>
      </div>
      <div class="colist arabic">
       <table>
        <tbody>
         <tr>
          <td><i class="conum" data-value="1"></i><b>1</b></td>
          <td>The bootstrap address used by Kafka clients.</td>
         </tr>
         <tr>
          <td><i class="conum" data-value="2"></i><b>2</b></td>
          <td>The advertised broker address pattern and port number used to form broker addresses. It must include the placeholder $(node) which will be substituted for the node id.</td>
         </tr>
         <tr>
          <td><i class="conum" data-value="3"></i><b>3</b></td>
          <td>TLS configuration.</td>
         </tr>
        </tbody>
       </table>
      </div>
      <div class="paragraph">
       <p>With the example configuration above, Kroxylicious is instructed to listen on port 9192, but advertise brokers of this virtual cluster as being available on port 443. This feature is useful where a network intermediary (such as another proxy or load balancer) is port forwarding.</p>
      </div>
      <div class="paragraph">
       <p>The gateway exposes the following broker addresses:</p>
      </div>
      <table class="tableblock frame-all grid-all stretch">
       <colgroup>
        <col style="width: 50%;">
        <col style="width: 50%;">
       </colgroup>
       <thead>
        <tr>
         <th class="tableblock halign-left valign-top">Node Id</th>
         <th class="tableblock halign-left valign-top">Broker Address</th>
        </tr>
       </thead>
       <tbody>
        <tr>
         <td class="tableblock halign-left valign-top">
          <p class="tableblock">0</p>
         </td>
         <td class="tableblock halign-left valign-top">
          <p class="tableblock">mybroker-0.mycluster.example.com:443</p>
         </td>
        </tr>
        <tr>
         <td class="tableblock halign-left valign-top">
          <p class="tableblock">…​</p>
         </td>
         <td class="tableblock halign-left valign-top">
          <p class="tableblock">…​</p>
         </td>
        </tr>
        <tr>
         <td class="tableblock halign-left valign-top">
          <p class="tableblock"><em>n</em></p>
         </td>
         <td class="tableblock halign-left valign-top">
          <p class="tableblock">mybroker-<em>n</em>.mycluster.example.com:443</p>
         </td>
        </tr>
       </tbody>
      </table>
      <div class="admonitionblock note">
       <table>
        <tbody>
         <tr>
          <td class="icon"><i class="fa icon-note" title="Note"></i></td>
          <td class="content">Single port operation may have cost advantages when using load balancers of public clouds, as it allows a single cloud provider load balancer to be shared across all virtual clusters.</td>
         </tr>
        </tbody>
       </table>
      </div>
     </div>
    </div>
    <div class="sect2">
     <h3 id="con-configuring-client-connections-proxy">2.5. Securing connections from clients</h3>
     <div class="paragraph _abstract">
      <p>To secure client connections to virtual clusters, configure TLS within the virtual cluster gateway by doing the following:</p>
     </div>
     <div class="ulist">
      <ul>
       <li>
        <p>Obtain a server certificate for the virtual cluster from a Certificate Authority (CA).
         <br>
         Ensure the certificate matches the names of the virtual cluster gateway’s bootstrap and broker addresses.
         <br>
         This may require wildcard certificates and Subject Alternative Names (SANs).</p>
       </li>
       <li>
        <p>Provide the TLS configuration using the <code>tls</code> properties in the virtual cluster gateway’s configuration to enable it to present the certificate to clients. Depending on your certificate format, apply one of the following examples.</p>
       </li>
       <li>
        <p>For mutual TLS, use the <code>trust</code> properties to configure the virtual cluster gateway to use TLS client authentication.</p>
       </li>
       <li>
        <p>If required, you can restrict the TLS protocols and cipher suites that are used to form the TLS connection.</p>
       </li>
      </ul>
     </div>
     <div class="paragraph">
      <p>Examples below illustrate how these steps may be done.</p>
     </div>
     <div class="admonitionblock note">
      <table>
       <tbody>
        <tr>
         <td class="icon"><i class="fa icon-note" title="Note"></i></td>
         <td class="content">TLS is recommended for production configurations.</td>
        </tr>
       </tbody>
      </table>
     </div>
     <div class="listingblock">
      <div class="title">Example applying a PKCS #12 server certificate to a virtual cluster gateway</div>
      <div class="content">
       <pre class="CodeRay highlight"><code data-lang="yaml"><span class="comment"># ...</span>
<span class="key">virtualClusters</span>:
  - <span class="string"><span class="content">name: my-cluster-proxy</span></span>
    <span class="comment"># ...</span>
    <span class="key">gateways</span>:
    - <span class="string"><span class="content">name: mygateway</span></span>
      <span class="comment"># ...</span>
      <span class="key">tls</span>:
        <span class="key">key</span>:
          <span class="key">storeFile</span>: <span class="string"><span class="content">&lt;path&gt;/server.p12  </span></span><i class="conum" data-value="1"></i><b>(1)</b>
          <span class="key">storePassword</span>:
            <span class="key">passwordFile</span>: <span class="string"><span class="content">&lt;path&gt;/store.password </span></span><i class="conum" data-value="2"></i><b>(2)</b>
          <span class="key">keyPassword</span>:
            <span class="key">passwordFile</span>: <span class="string"><span class="content">&lt;path&gt;/key.password </span></span><i class="conum" data-value="3"></i><b>(3)</b>
          <span class="key">storeType</span>: <span class="string"><span class="content">PKCS12</span></span> <i class="conum" data-value="4"></i><b>(4)</b>
<span class="comment"># ...</span></code></pre>
      </div>
     </div>
     <div class="colist arabic">
      <table>
       <tbody>
        <tr>
         <td><i class="conum" data-value="1"></i><b>1</b></td>
         <td>PKCS #12 store containing the private-key and certificate/intermediates of the virtual cluster gateway.</td>
        </tr>
        <tr>
         <td><i class="conum" data-value="2"></i><b>2</b></td>
         <td>Password to protect the PKCS #12 store.</td>
        </tr>
        <tr>
         <td><i class="conum" data-value="3"></i><b>3</b></td>
         <td>(Optional) Password for the key. If a password is not specified, the keystore’s password is used to decrypt the key too.</td>
        </tr>
        <tr>
         <td><i class="conum" data-value="4"></i><b>4</b></td>
         <td>(Optional) Keystore type. If a keystore type is not specified, the default JKS (Java Keystore) type is used.</td>
        </tr>
       </tbody>
      </table>
     </div>
     <div class="listingblock">
      <div class="title">Example applying a PEM server certificate and key pair to a virtual cluster gateway</div>
      <div class="content">
       <pre class="CodeRay highlight"><code data-lang="yaml"><span class="comment"># ...</span>
<span class="key">virtualClusters</span>:
  - <span class="string"><span class="content">name: my-cluster-proxy</span></span>
    <span class="comment"># ...</span>
    <span class="key">gateways</span>:
    - <span class="string"><span class="content">name: mygateway</span></span>
      <span class="comment"># ...</span>
      <span class="key">tls</span>:
        <span class="key">key</span>:
          <span class="key">privateKeyFile</span>: <span class="string"><span class="content">&lt;path&gt;/server.key   </span></span><i class="conum" data-value="1"></i><b>(1)</b>
          <span class="key">certificateFile</span>: <span class="string"><span class="content">&lt;path&gt;/server.crt </span></span><i class="conum" data-value="2"></i><b>(2)</b>
          <span class="key">keyPassword</span>:
            <span class="key">passwordFile</span>: <span class="string"><span class="content">&lt;path&gt;/key.password</span></span> <i class="conum" data-value="3"></i><b>(3)</b>
<span class="comment"># ...</span></code></pre>
      </div>
     </div>
     <div class="colist arabic">
      <table>
       <tbody>
        <tr>
         <td><i class="conum" data-value="1"></i><b>1</b></td>
         <td>Private key of the virtual cluster gateway.</td>
        </tr>
        <tr>
         <td><i class="conum" data-value="2"></i><b>2</b></td>
         <td>Public certificate of the virtual cluster gateway.</td>
        </tr>
        <tr>
         <td><i class="conum" data-value="3"></i><b>3</b></td>
         <td>(Optional) Password for the key.</td>
        </tr>
       </tbody>
      </table>
     </div>
     <div class="paragraph">
      <p>You can configure the virtual cluster gateway to require that clients present a certificate for authentication. The virtual cluster gateway verifies that the client’s certificate is signed by one of the CA certificates contained in a trust store. If verification fails, the client’s connection is refused.</p>
     </div>
     <div class="listingblock">
      <div class="title">Example applying TLS client authentication using a PKCS #12 truststore</div>
      <div class="content">
       <pre class="CodeRay highlight"><code data-lang="yaml"><span class="comment"># ...</span>
<span class="key">virtualClusters</span>:
  - <span class="string"><span class="content">name: my-cluster-proxy</span></span>
    <span class="comment"># ...</span>
    <span class="key">gateways</span>:
    - <span class="string"><span class="content">name: mygateway</span></span>
      <span class="comment"># ...</span>
      <span class="key">tls</span>:
        <span class="key">key</span>:
           <span class="comment"># ...</span>
        <span class="key">trust</span>:
          <span class="key">storeFile</span>: <span class="string"><span class="content">&lt;path&gt;/trust.p12 </span></span><i class="conum" data-value="1"></i><b>(1)</b>
          <span class="key">storePassword</span>:
            <span class="key">passwordFile</span>: <span class="string"><span class="content">&lt;path&gt;/trust.password </span></span><i class="conum" data-value="2"></i><b>(2)</b>
          <span class="key">storeType</span>: <span class="string"><span class="content">PKCS12 </span></span><i class="conum" data-value="3"></i><b>(3)</b>
          <span class="key">trustOptions</span>:
            <span class="key">clientAuth</span>: <span class="string"><span class="content">REQUIRED</span></span> <i class="conum" data-value="4"></i><b>(4)</b>
<span class="comment"># ...</span></code></pre>
      </div>
     </div>
     <div class="colist arabic">
      <table>
       <tbody>
        <tr>
         <td><i class="conum" data-value="1"></i><b>1</b></td>
         <td>PKCS #12 store containing CA certificate(s) used to verify that the client’s certificate is trusted.</td>
        </tr>
        <tr>
         <td><i class="conum" data-value="2"></i><b>2</b></td>
         <td>(Optional) Password to protect the PKCS #12 store.</td>
        </tr>
        <tr>
         <td><i class="conum" data-value="3"></i><b>3</b></td>
         <td>(Optional) Keystore type. If a keystore type is not specified, the default JKS (Java Keystore) type is used.</td>
        </tr>
        <tr>
         <td><i class="conum" data-value="4"></i><b>4</b></td>
         <td>(Optional) Client authentication mode. If set to <code>REQUIRED</code>, the client must present a valid certificate. If set to <code>REQUESTED</code>, the client is requested to present a certificate. If presented, the certificate is validated. If the client chooses not to present a certificate the connection is still allowed. If set to <code>NONE</code>, client authentication is disabled. If a client authentication mode is not specified, then the default behaviour is <code>REQUIRED</code>.</td>
        </tr>
       </tbody>
      </table>
     </div>
     <div class="admonitionblock note">
      <table>
       <tbody>
        <tr>
         <td class="icon"><i class="fa icon-note" title="Note"></i></td>
         <td class="content">The client’s identity, as established through TLS client authentication, is currently not relayed to the target cluster. For more information, see the <a href="https://github.com/kroxylicious/kroxylicious/issues/1637" target="_blank" rel="noopener">related issue</a>.</td>
        </tr>
       </tbody>
      </table>
     </div>
     <div class="paragraph">
      <p>You can restrict the TLS protocols by specifying either an allow list of TLS protocols to be enabled, or a deny list of TLS protocols to be disallowed from the platform’s default. If both an allow and a deny list are specified, the resulting list of TLS protocols includes only those protocols from the allow list that are not in the deny list. If neither list is specified, the virtual cluster uses the default TLS protocols provided by the platform.</p>
     </div>
     <div class="paragraph">
      <p>When the client connects, it negotiates the highest mutually acceptable TLS protocol with the virtual cluster. If the two have no protocols in common, the connection fails.</p>
     </div>
     <div class="paragraph">
      <p>The names of the TLS protocols are defined by <a href="https://docs.oracle.com/en/java/javase/17/docs/specs/security/standard-names.html#sslcontext-algorithms">Java specification</a>.</p>
     </div>
     <div class="listingblock">
      <div class="title">Example restricting TLS protocols using an allow list</div>
      <div class="content">
       <pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">virtualClusters</span>:
  - <span class="string"><span class="content">name: my-cluster-proxy</span></span>
    <span class="comment"># ...</span>
    <span class="key">gateways</span>:
    - <span class="string"><span class="content">name: mygateway</span></span>
      <span class="comment"># ...</span>
      <span class="key">tls</span>:
        <span class="comment"># ...</span>
        <span class="key">protocols</span>:
          <span class="key">allowed</span>:  <i class="conum" data-value="1"></i><b>(1)</b>
          - <span class="string"><span class="content">TLSv1.3</span></span>
          - <span class="string"><span class="content">TLSv1.2</span></span></code></pre>
      </div>
     </div>
     <div class="colist arabic">
      <table>
       <tbody>
        <tr>
         <td><i class="conum" data-value="1"></i><b>1</b></td>
         <td>List of allowed TLS protocols.</td>
        </tr>
       </tbody>
      </table>
     </div>
     <div class="listingblock">
      <div class="title">Example restricting TLS protocols using a deny list</div>
      <div class="content">
       <pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">virtualClusters</span>:
  - <span class="string"><span class="content">name: my-cluster-proxy</span></span>
    <span class="comment"># ...</span>
    <span class="key">gateways</span>:
    - <span class="string"><span class="content">name: mygateway</span></span>
      <span class="comment"># ...</span>
      <span class="key">tls</span>:
        <span class="comment"># ...</span>
        <span class="key">protocols</span>:
          <span class="key">denied</span>:  <i class="conum" data-value="1"></i><b>(1)</b>
          - <span class="string"><span class="content">TLSv1.1</span></span></code></pre>
      </div>
     </div>
     <div class="colist arabic">
      <table>
       <tbody>
        <tr>
         <td><i class="conum" data-value="1"></i><b>1</b></td>
         <td>List of disallowed TLS protocols.</td>
        </tr>
       </tbody>
      </table>
     </div>
     <div class="paragraph">
      <p>You can restrict the TLS cipher suite by specifying either an allow list of cipher suites to be enabled, in preference order, or a deny list of ciphers suites to be disallowed from the platform’s default. If both an allow and a deny list are specified, the resulting list of cipher suites includes only those ciphers from the allow list that are not in the deny list. If neither list is specified, the virtual cluster uses the default cipher suites (and preference order) provided by the platform.</p>
     </div>
     <div class="paragraph">
      <p>When the client connects, it negotiates the most preferred mutually acceptable cipher suite with the virtual cluster. If the two have no cipher suites in common, the connection fails.</p>
     </div>
     <div class="paragraph">
      <p>The names of the cipher suite are defined by <a href="https://docs.oracle.com/en/java/javase/17/docs/specs/security/standard-names.html#jsse-cipher-suite-names">Java specification</a>.</p>
     </div>
     <div class="listingblock">
      <div class="title">Example restricting cipher suites using an allow list</div>
      <div class="content">
       <pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">virtualClusters</span>:
  - <span class="string"><span class="content">name: my-cluster-proxy</span></span>
    <span class="comment"># ...</span>
    <span class="key">gateways</span>:
    - <span class="string"><span class="content">name: mygateway</span></span>
      <span class="comment"># ...</span>
      <span class="key">tls</span>:
        <span class="comment"># ...</span>
        <span class="key">cipherSuites</span>:
          <span class="key">allowed</span>:  <i class="conum" data-value="1"></i><b>(1)</b>
          - <span class="string"><span class="content">TLS_ECDHE_ECDSA_WITH_AES_256_CCM</span></span>
          - <span class="string"><span class="content">TLS_ECDHE_ECDSA_WITH_AES_128_CCM</span></span></code></pre>
      </div>
     </div>
     <div class="colist arabic">
      <table>
       <tbody>
        <tr>
         <td><i class="conum" data-value="1"></i><b>1</b></td>
         <td>List of allowed cipher suites in preference order.</td>
        </tr>
       </tbody>
      </table>
     </div>
     <div class="listingblock">
      <div class="title">Example restricting cipher suites using a deny list</div>
      <div class="content">
       <pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">virtualClusters</span>:
  - <span class="string"><span class="content">name: my-cluster-proxy</span></span>
    <span class="comment"># ...</span>
    <span class="key">gateways</span>:
    - <span class="string"><span class="content">name: mygateway</span></span>
      <span class="comment"># ...</span>
      <span class="key">tls</span>:
        <span class="comment"># ...</span>
        <span class="key">cipherSuites</span>:
          <span class="key">denied</span>:  <i class="conum" data-value="1"></i><b>(1)</b>
          - <span class="string"><span class="content">TLS_KRB5_WITH_3DES_EDE_CBC_MD5</span></span></code></pre>
      </div>
     </div>
     <div class="colist arabic">
      <table>
       <tbody>
        <tr>
         <td><i class="conum" data-value="1"></i><b>1</b></td>
         <td>List of disallowed cipher suites.</td>
        </tr>
       </tbody>
      </table>
     </div>
    </div>
    <div class="sect2">
     <h3 id="con-configuring-target-cluster-connections-proxy">2.6. Securing connections to target clusters</h3>
     <div class="paragraph _abstract">
      <p>To secure connections from the virtual cluster to the upstream cluster, configure the target cluster’s TLS setting by doing the following:</p>
     </div>
     <div class="ulist">
      <ul>
       <li>
        <p>If the upstream is using a private CA, use the <code>trust</code> properties to configure a truststore for the target cluster.</p>
       </li>
       <li>
        <p>If you want to use mutual TLS, specify the certificate with the <code>key</code> property to identify the virtual cluster to the upstream.</p>
       </li>
       <li>
        <p>If required, you can restrict the TLS protocols and cipher suites that are used to form the TLS connection.</p>
       </li>
      </ul>
     </div>
     <div class="admonitionblock note">
      <table>
       <tbody>
        <tr>
         <td class="icon"><i class="fa icon-note" title="Note"></i></td>
         <td class="content">TLS is recommended on Kafka clients and virtual clusters for production configurations.</td>
        </tr>
       </tbody>
      </table>
     </div>
     <div class="paragraph">
      <p>Examples below illustrate how these steps may be done.</p>
     </div>
     <div class="paragraph">
      <p>Using an empty object (<code>{}</code>) enables TLS using the platform’s defaults. This means that platform trust, and default protocols and cipher suites will be used. This option is suitable if the upstream cluster is using a TLS certificate signed by a public CA and the platform’s defaults are suitable.</p>
     </div>
     <div class="listingblock">
      <div class="title">Example enabling TLS for a target cluster using platform defaults</div>
      <div class="content">
       <pre class="CodeRay highlight"><code data-lang="yaml"><span class="comment"># ...</span>
<span class="key">virtualClusters</span>:
  - <span class="string"><span class="content">name: my-cluster-proxy</span></span>
    <span class="comment"># ...</span>
    <span class="key">targetCluster</span>:
      <span class="key">bootstrapServers</span>: <span class="string"><span class="content">my-cluster-kafka-bootstrap.kafka.svc.cluster.local:9093</span></span>
      <span class="key">tls</span>: <span class="string"><span class="content">{}</span></span>
<span class="comment"># ...</span></code></pre>
      </div>
     </div>
     <div class="paragraph">
      <p>If it is using a TLS certificate signed by a private CA, you must add truststore configuration for the target cluster. The example illustrates using PKCS #12 format. PEM format is supported too.</p>
     </div>
     <div class="listingblock">
      <div class="title">Example specifying a truststore</div>
      <div class="content">
       <pre class="CodeRay highlight"><code data-lang="yaml"><span class="comment"># ...</span>
<span class="key">virtualClusters</span>:
  - <span class="string"><span class="content">name: my-cluster-proxy</span></span>
    <span class="comment"># ...</span>
    <span class="key">targetCluster</span>:
      <span class="key">bootstrapServers</span>: <span class="string"><span class="content">my-cluster-kafka-bootstrap.kafka.svc.cluster.local:9093</span></span>
      <span class="key">tls</span>:
        <span class="key">trust</span>:
          <span class="key">storeFile</span>: <span class="string"><span class="content">&lt;path&gt;/trust.p12 </span></span><i class="conum" data-value="1"></i><b>(1)</b>
          <span class="key">storePassword</span>:
            <span class="key">passwordFile</span>: <span class="string"><span class="content">&lt;path&gt;/store.password </span></span><i class="conum" data-value="2"></i><b>(2)</b>
          <span class="key">storeType</span>: <span class="string"><span class="content">PKCS12</span></span> <i class="conum" data-value="3"></i><b>(3)</b>
<span class="comment"># ...</span></code></pre>
      </div>
     </div>
     <div class="colist arabic">
      <table>
       <tbody>
        <tr>
         <td><i class="conum" data-value="1"></i><b>1</b></td>
         <td>PKCS #12 store for the public CA certificate of the Kafka cluster.</td>
        </tr>
        <tr>
         <td><i class="conum" data-value="2"></i><b>2</b></td>
         <td>Password to access the public Kafka cluster CA certificate.</td>
        </tr>
        <tr>
         <td><i class="conum" data-value="3"></i><b>3</b></td>
         <td>(Optional) Keystore type. If a keystore type is not specified, the default JKS (Java Keystore) type is used.</td>
        </tr>
       </tbody>
      </table>
     </div>
     <div class="paragraph">
      <p>For mutual TLS, add a keystore configuration for the virtual cluster. The following example uses a PEM format server certificate and key pair. PKCS #12 keystore format is supported too.</p>
     </div>
     <div class="listingblock">
      <div class="title">Example configuring mutual TLS</div>
      <div class="content">
       <pre class="CodeRay highlight"><code data-lang="yaml"><span class="comment"># ...</span>
<span class="key">virtualClusters</span>:
  - <span class="string"><span class="content">name: my-cluster-proxy</span></span>
    <span class="comment"># ...</span>
    <span class="key">targetCluster</span>:
      <span class="key">bootstrapServers</span>: <span class="string"><span class="content">my-cluster-kafka-bootstrap.kafka.svc.cluster.local:9093</span></span>
      <span class="key">tls</span>:
        <span class="key">key</span>:
          <span class="key">privateKeyFile</span>: <span class="string"><span class="content">&lt;path&gt;/client.key </span></span><i class="conum" data-value="1"></i><b>(1)</b>
          <span class="key">certificateFile</span>: <span class="string"><span class="content">&lt;path&gt;/client.crt</span></span> <i class="conum" data-value="2"></i><b>(2)</b>
<span class="comment"># ...</span></code></pre>
      </div>
     </div>
     <div class="colist arabic">
      <table>
       <tbody>
        <tr>
         <td><i class="conum" data-value="1"></i><b>1</b></td>
         <td>Private key of the virtual cluster.</td>
        </tr>
        <tr>
         <td><i class="conum" data-value="2"></i><b>2</b></td>
         <td>Public CA certificate of the virtual cluster.</td>
        </tr>
       </tbody>
      </table>
     </div>
     <div class="paragraph">
      <p>The TLS protocols and cipher suites available to the TLS connection may also be configured.</p>
     </div>
     <div class="listingblock">
      <div class="title">Example restricting TLS protocols using an allow list</div>
      <div class="content">
       <pre class="CodeRay highlight"><code data-lang="yaml"><span class="comment"># ...</span>
<span class="key">virtualClusters</span>:
  - <span class="string"><span class="content">name: my-cluster-proxy</span></span>
    <span class="comment"># ...</span>
    <span class="key">targetCluster</span>:
      <span class="key">bootstrapServers</span>: <span class="string"><span class="content">my-cluster-kafka-bootstrap.kafka.svc.cluster.local:9093</span></span>
      <span class="key">tls</span>:
        <span class="comment"># ...</span>
        <span class="key">protocols</span>:
          <span class="key">allowed</span>:  <i class="conum" data-value="1"></i><b>(1)</b>
          - <span class="string"><span class="content">TLSv1.3</span></span>
          - <span class="string"><span class="content">TLSv1.2</span></span></code></pre>
      </div>
     </div>
     <div class="colist arabic">
      <table>
       <tbody>
        <tr>
         <td><i class="conum" data-value="1"></i><b>1</b></td>
         <td>List of allowed TLS protocols.</td>
        </tr>
       </tbody>
      </table>
     </div>
     <div class="listingblock">
      <div class="title">Example restricting TLS protocols using a deny list</div>
      <div class="content">
       <pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">virtualClusters</span>:
  - <span class="string"><span class="content">name: my-cluster-proxy</span></span>
    <span class="key">targetCluster</span>:
      <span class="key">bootstrapServers</span>: <span class="string"><span class="content">my-cluster-kafka-bootstrap.kafka.svc.cluster.local:9093</span></span>
      <span class="key">tls</span>:
        <span class="comment"># ...</span>
        <span class="key">protocols</span>:
          <span class="key">denied</span>:  <i class="conum" data-value="1"></i><b>(1)</b>
          - <span class="string"><span class="content">TLSv1.1</span></span></code></pre>
      </div>
     </div>
     <div class="colist arabic">
      <table>
       <tbody>
        <tr>
         <td><i class="conum" data-value="1"></i><b>1</b></td>
         <td>List of disallowed TLS protocols.</td>
        </tr>
       </tbody>
      </table>
     </div>
     <div class="listingblock">
      <div class="title">Example restricting cipher suites using an allow list</div>
      <div class="content">
       <pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">virtualClusters</span>:
  - <span class="string"><span class="content">name: my-cluster-proxy</span></span>
    <span class="key">targetCluster</span>:
      <span class="key">bootstrapServers</span>: <span class="string"><span class="content">my-cluster-kafka-bootstrap.kafka.svc.cluster.local:9093</span></span>
      <span class="key">tls</span>:
        <span class="comment"># ...</span>
        <span class="key">cipherSuites</span>:
          <span class="key">allowed</span>:  <i class="conum" data-value="1"></i><b>(1)</b>
          - <span class="string"><span class="content">TLS_ECDHE_ECDSA_WITH_AES_256_CCM</span></span>
          - <span class="string"><span class="content">TLS_ECDHE_ECDSA_WITH_AES_128_CCM</span></span></code></pre>
      </div>
     </div>
     <div class="colist arabic">
      <table>
       <tbody>
        <tr>
         <td><i class="conum" data-value="1"></i><b>1</b></td>
         <td>List of allowed cipher suites.</td>
        </tr>
       </tbody>
      </table>
     </div>
     <div class="listingblock">
      <div class="title">Example restricting cipher suites using a deny list</div>
      <div class="content">
       <pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">virtualClusters</span>:
  - <span class="string"><span class="content">name: my-cluster-proxy</span></span>
    <span class="key">targetCluster</span>:
      <span class="key">bootstrapServers</span>: <span class="string"><span class="content">my-cluster-kafka-bootstrap.kafka.svc.cluster.local:9093</span></span>
      <span class="key">tls</span>:
        <span class="comment"># ...</span>
        <span class="key">cipherSuites</span>:
          <span class="key">denied</span>:  <i class="conum" data-value="1"></i><b>(1)</b>
          - <span class="string"><span class="content">TLS_KRB5_WITH_3DES_EDE_CBC_MD5</span></span></code></pre>
      </div>
     </div>
     <div class="colist arabic">
      <table>
       <tbody>
        <tr>
         <td><i class="conum" data-value="1"></i><b>1</b></td>
         <td>List of disallowed cipher suites.</td>
        </tr>
       </tbody>
      </table>
     </div>
     <div class="paragraph">
      <p>For the purposes of testing (that is, outside a production environment), you can set the <code>insecure</code> property to <code>true</code> to disable TLS trust checks (hostname verification and certificate validation) so that the Kroxylicious can connect to any Kafka cluster.</p>
     </div>
     <div class="listingblock">
      <div class="title">Example configuration to disable TLS trust checks</div>
      <div class="content">
       <pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">virtualClusters</span>:
  - <span class="string"><span class="content">name: my-cluster-proxy</span></span>
    <span class="key">targetCluster</span>:
      <span class="key">bootstrapServers</span>: <span class="string"><span class="content">dev-cluster-kafka-bootstrap.kafka.svc.cluster.local:9093</span></span>
      <span class="key">tls</span>:
        <span class="key">trust</span>:
          <span class="key">insecure</span>: <span class="string"><span class="content">true</span></span>
<span class="comment"># ...</span></code></pre>
      </div>
     </div>
    </div>
    <div class="sect2">
     <h3 id="ref-configuring-vc-other-settings-proxy">2.7. Configuring other Virtual Cluster settings</h3>
     <div class="sect3">
      <h4 id="per_virtual_cluster_logging">2.7.1. Per-virtual cluster logging</h4>
      <div class="paragraph">
       <p>You can enable low level logging on a per-virtual cluster basis. The <code>logNetwork</code> property controls logging of information about requests and responses at the network level, before they’ve been decoded into Kafka requests and responses. The <code>logFrames</code> property controls logging of the decoded requests and responses.</p>
      </div>
      <div id="con-configuring-vc-logging-proxy" class="listingblock">
       <div class="title">Configuration fragment showing logging properties</div>
       <div class="content">
        <pre class="CodeRay highlight"><code data-lang="yaml"><span class="comment"># ...</span>
<span class="key">virtualClusters</span>:
  - <span class="string"><span class="content">name: my-cluster-proxy</span></span>
    <span class="comment"># ...</span>
    <span class="key">logNetwork</span>: <span class="string"><span class="content">true </span></span><i class="conum" data-value="1"></i><b>(1)</b>
    <span class="key">logFrames</span>: <span class="string"><span class="content">true</span></span> <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="comment"># ...</span></code></pre>
       </div>
      </div>
      <div class="colist arabic">
       <table>
        <tbody>
         <tr>
          <td><i class="conum" data-value="1"></i><b>1</b></td>
          <td>Enables low-level network logging for the virtual cluster.</td>
         </tr>
         <tr>
          <td><i class="conum" data-value="2"></i><b>2</b></td>
          <td>Enables low-level protocol frame logging for the virtual cluster.</td>
         </tr>
        </tbody>
       </table>
      </div>
     </div>
    </div>
    <div class="sect2">
     <h3 id="ref-configuring-toplevel-other-settings-proxy">2.8. Configuring other top level settings</h3>
     <div class="sect3">
      <h4 id="management_http_endpoints">2.8.1. Management HTTP endpoints</h4>
      <div class="paragraph">
       <p>The proxy can run an HTTP server for exposing basic management information. This is configured with the top level <code>management</code> property.</p>
      </div>
      <div id="con-configuring-admin-http-proxy" class="listingblock">
       <div class="title">
        Configuration fragment showing the <code>management</code> property
       </div>
       <div class="content">
        <pre class="CodeRay highlight"><code data-lang="yaml"><span class="comment"># ... (filterDefinitions, virtualClusters etc)</span>
<span class="key">management</span>:
  <span class="key">bindAddress</span>: <span class="string"><span class="content">0.0.0.0 </span></span><i class="conum" data-value="1"></i><b>(1)</b>
  <span class="key">port</span>: <span class="string"><span class="content">9190 </span></span><i class="conum" data-value="2"></i><b>(2)</b>
  <span class="key">endpoints</span>: <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="key">prometheus</span>: <span class="string"><span class="content">{} </span></span><i class="conum" data-value="4"></i><b>(4)</b></code></pre>
       </div>
      </div>
      <div class="colist arabic">
       <table>
        <tbody>
         <tr>
          <td><i class="conum" data-value="1"></i><b>1</b></td>
          <td>The address the HTTP server should bind to. Defaults to <code>0.0.0.0</code>.</td>
         </tr>
         <tr>
          <td><i class="conum" data-value="2"></i><b>2</b></td>
          <td>The port the HTTP server should bind to. Defaults to <code>9190</code>.</td>
         </tr>
         <tr>
          <td><i class="conum" data-value="3"></i><b>3</b></td>
          <td>Control over the exposed endpoints</td>
         </tr>
         <tr>
          <td><i class="conum" data-value="4"></i><b>4</b></td>
          <td>If present and not null, exposes a Prometheus scrape endpoint at path <code>/metrics</code>.</td>
         </tr>
        </tbody>
       </table>
      </div>
     </div>
    </div>
    <div class="sect2">
     <h3 id="ref-configuring-proxy-example-proxy">2.9. Example Kroxylicious configuration</h3>
     <div class="ulist">
      <ul>
       <li>
        <p>Virtual clusters that represent the Kafka clusters</p>
       </li>
       <li>
        <p>Network addresses for broker communication in a Kafka cluster</p>
       </li>
       <li>
        <p>Filters to introduce additional functionality to the Kafka deployment</p>
       </li>
      </ul>
     </div>
     <div class="paragraph">
      <p>In this example, configuration for the Record Encryption filter is shown.</p>
     </div>
     <div id="con-deploying-upstream-tls-proxy" class="listingblock">
      <div class="title">Example Kroxylicious configuration</div>
      <div class="content">
       <pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">filterDefinitions</span>: <i class="conum" data-value="1"></i><b>(1)</b>
  - <span class="string"><span class="content">name: encryption</span></span>
    <span class="key">type</span>: <span class="string"><span class="content">RecordEncryption </span></span><i class="conum" data-value="2"></i><b>(2)</b>
    <span class="key">config</span>: <i class="conum" data-value="3"></i><b>(3)</b>
      <span class="key">kms</span>: <span class="string"><span class="content">VaultKmsService</span></span>
      <span class="key">kmsConfig</span>:
        <span class="key">vaultTransitEngineUrl</span>: <span class="string"><span class="content">https://vault.vault.svc.cluster.local:8200/v1/transit</span></span>
        <span class="key">vaultToken</span>:
          <span class="key">passwordFile</span>: <span class="string"><span class="content">/opt/proxy/server/token.txt</span></span>
        <span class="key">tls</span>: <i class="conum" data-value="4"></i><b>(4)</b>
          <span class="key">key</span>:
            <span class="key">storeFile</span>: <span class="string"><span class="content">/opt/cert/server.p12</span></span>
            <span class="key">storePassword</span>:
              <span class="key">passwordFile</span>: <span class="string"><span class="content">/opt/cert/store.password</span></span>
            <span class="key">keyPassword</span>:
              <span class="key">passwordFile</span>: <span class="string"><span class="content">/opt/cert/key.password</span></span>
            <span class="key">storeType</span>: <span class="string"><span class="content">PKCS12</span></span>
      <span class="key">selector</span>: <span class="string"><span class="content">TemplateKekSelector</span></span>
      <span class="key">selectorConfig</span>:
        <span class="key">template</span>: <span class="string"><span class="delimiter">"</span><span class="content">$(topicName)</span><span class="delimiter">"</span></span>
<span class="key">defaultFilters</span>:
  - <span class="string"><span class="content">encryption</span></span>
<span class="key">virtualClusters</span>: <i class="conum" data-value="5"></i><b>(5)</b>
  - <span class="string"><span class="content">name: my-cluster-proxy </span></span><i class="conum" data-value="6"></i><b>(6)</b>
    <span class="key">targetCluster</span>:
      <span class="key">bootstrapServers</span>: <span class="string"><span class="content">my-cluster-kafka-bootstrap.kafka.svc.cluster.local:9093 </span></span><i class="conum" data-value="7"></i><b>(7)</b>
      <span class="key">tls</span>: <i class="conum" data-value="8"></i><b>(8)</b>
        <span class="key">trust</span>:
          <span class="key">storeFile</span>: <span class="string"><span class="content">/opt/proxy/trust/ca.p12</span></span>
          <span class="key">storePassword</span>:
            <span class="key">passwordFile</span>: <span class="string"><span class="content">/opt/proxy/trust/ca.password</span></span>
    <span class="key">gateways</span>: <i class="conum" data-value="9"></i><b>(9)</b>
    - <span class="string"><span class="content">name: mygateway</span></span>
      <span class="key">sniHostIdentifiesNode</span>: <i class="conum" data-value="10"></i><b>(10)</b>
        <span class="key">bootstrapAddress</span>: <span class="string"><span class="content">my-cluster-proxy.kafka:9092 </span></span><i class="conum" data-value="11"></i><b>(11)</b>
        <span class="key">advertisedBrokerAddressPattern</span>: <span class="string"><span class="content">broker$(nodeId).my-cluster-proxy.kafka</span></span>
      <span class="key">tls</span>: <i class="conum" data-value="12"></i><b>(12)</b>
        <span class="key">key</span>:
          <span class="key">storeFile</span>: <span class="string"><span class="content">/opt/proxy/server/key-material/keystore.p12</span></span>
          <span class="key">storePassword</span>:
            <span class="key">passwordFile</span>: <span class="string"><span class="content">/opt/proxy/server/keystore-password/storePassword</span></span></code></pre>
      </div>
     </div>
     <div class="colist arabic">
      <table>
       <tbody>
        <tr>
         <td><i class="conum" data-value="1"></i><b>1</b></td>
         <td>A list of named filter configurations.</td>
        </tr>
        <tr>
         <td><i class="conum" data-value="2"></i><b>2</b></td>
         <td>The type of filter, which is the Record Encryption filter using Vault as the KMS in this example.</td>
        </tr>
        <tr>
         <td><i class="conum" data-value="3"></i><b>3</b></td>
         <td>The configuration specific to the type of filter.</td>
        </tr>
        <tr>
         <td><i class="conum" data-value="4"></i><b>4</b></td>
         <td>If required, you can also specify the credentials for TLS authentication with the KMS, with key names under which TLS certificates are stored.</td>
        </tr>
        <tr>
         <td><i class="conum" data-value="5"></i><b>5</b></td>
         <td>Virtual cluster configuration.</td>
        </tr>
        <tr>
         <td><i class="conum" data-value="6"></i><b>6</b></td>
         <td>The name of the virtual cluster.</td>
        </tr>
        <tr>
         <td><i class="conum" data-value="7"></i><b>7</b></td>
         <td>The bootstrap address of the target physical Kafka Cluster being proxied.</td>
        </tr>
        <tr>
         <td><i class="conum" data-value="8"></i><b>8</b></td>
         <td>TLS configuration for the connection to the target cluster.</td>
        </tr>
        <tr>
         <td><i class="conum" data-value="9"></i><b>9</b></td>
         <td>The gateway of the virtual cluster defining how the virtual cluster is presented to the network.</td>
        </tr>
        <tr>
         <td><i class="conum" data-value="10"></i><b>10</b></td>
         <td>The identification scheme used to route traffic to brokers, which can be <code>sniHostIdentifiesNode</code> or <code>portIdentifiesNode</code>.</td>
        </tr>
        <tr>
         <td><i class="conum" data-value="11"></i><b>11</b></td>
         <td>The hostname and port of the bootstrap used by the Kafka clients to connect to the gateway. The hostname must be resolved by the clients.</td>
        </tr>
        <tr>
         <td><i class="conum" data-value="12"></i><b>12</b></td>
         <td>TLS encryption used by the gateway for securing connections with the clients.</td>
        </tr>
       </tbody>
      </table>
     </div>
    </div>
   </div>
  </div>
  <div class="sect1">
   <h2 id="assembly-built-in-filters-proxy">3. Built-in filters</h2>
   <div class="sectionbody">
    <div class="paragraph _abstract">
     <p>Kroxylicious comes with a suite of built-in filters designed to enhance the functionality and security of your Kafka clusters.</p>
    </div>
    <div class="sect2">
     <h3 id="record_encryption_filter">3.1. Record Encryption filter</h3>
     <div class="paragraph">
      <p>The Kroxylicious Record Encryption filter enables encryption-at-rest for Apache Kafka clusters. For information on using the filter, see the <a href="../record-encryption-guide/">Kroxylicious Record Encryption guide</a>.</p>
     </div>
    </div>
    <div class="sect2">
     <h3 id="assembly-multi-tenancy-filter-proxy">3.2. (Preview) Multi-tenancy filter</h3>
     <div class="paragraph _abstract">
      <p>Kroxylicious’s Multi-tenancy filter presents a single Kafka cluster to tenants as if it were multiple clusters. Operations are isolated to a single tenant by prefixing resources with an identifier.</p>
     </div>
     <div class="admonitionblock note">
      <table>
       <tbody>
        <tr>
         <td class="icon"><i class="fa icon-note" title="Note"></i></td>
         <td class="content">This filter is currently in incubation and available as a preview. We would not recommend using it in a production environment.</td>
        </tr>
       </tbody>
      </table>
     </div>
     <div class="paragraph">
      <p>The Multi-tenancy filter works by intercepting all Kafka RPCs (remote procedure calls) that reference resources, such as topic names and consumer group names:</p>
     </div>
     <div class="dlist">
      <dl>
       <dt class="hdlist1">Request path</dt>
       <dd>
        <p>On the request path, resource names are prefixed with a tenant identifier.</p>
       </dd>
       <dt class="hdlist1">Response path</dt>
       <dd>
        <p>On the response path, the prefix is removed.</p>
       </dd>
      </dl>
     </div>
     <div class="paragraph">
      <p>Kafka RPCs that list resources are filtered so that only resources belonging to the tenant are returned, effectively creating a private cluster experience for each tenant.</p>
     </div>
     <div class="paragraph">
      <p>To set up the filter, configure it in Kroxylicious.</p>
     </div>
     <div class="admonitionblock important">
      <table>
       <tbody>
        <tr>
         <td class="icon"><i class="fa icon-important" title="Important"></i></td>
         <td class="content">While the Multi-tenancy filter isolates operations on resources, it does not isolate user identities across tenants. User authentication and ACLs (Access Control Lists) are shared across all tenants, meaning that identity is not scoped to individual tenants. For more information on open issues related to this filter, see <a href="https://github.com/kroxylicious/kroxylicious/issues" target="_blank" rel="noopener">Kroxylicious issues</a>.</td>
        </tr>
       </tbody>
      </table>
     </div>
     <div class="admonitionblock note">
      <table>
       <tbody>
        <tr>
         <td class="icon"><i class="fa icon-note" title="Note"></i></td>
         <td class="content">For more information on Kafka’s support for multi-tenancy, see the <a href="https://kafka.apache.org" target="_blank" rel="noopener">Apache Kafka website</a>.</td>
        </tr>
       </tbody>
      </table>
     </div>
     <div class="sect3">
      <h4 id="proc-multi-tenancy-proxy">3.2.1. (Preview) Setting up the Multi-tenancy filter</h4>
      <div class="paragraph _abstract">
       <p>This procedure describes how to set up the Multi-tenancy filter by configuring it in Kroxylicious. The filter dynamically prefixes resource names to create isolation between tenants using the same Kafka cluster. The prefix representing a tenant is taken from the name of the virtual cluster representing the tenant. For example, if the virtual cluster is named <code>tenant-1</code>, the prefix is <code>tenant-1</code>. Each tenant must be represented by a unique virtual cluster, and virtual cluster names must be globally unique within the Kroxylicious configuration. This means that the same virtual cluster name cannot be used to represent different Kafka clusters.</p>
      </div>
      <div class="ulist">
       <div class="title">Prerequisites</div>
       <ul>
        <li>
         <p>An instance of Kroxylicious. For information on deploying Kroxylicious, see the <a href="https://github.com/kroxylicious/kroxylicious" target="_blank" rel="noopener">samples and examples</a>.</p>
        </li>
        <li>
         <p>A config map for Kroxylicious that includes the configuration for creating virtual clusters and filters.</p>
        </li>
        <li>
         <p>A virtual cluster definition for each tenant using the Kafka cluster. You need at least two virtual clusters to apply multi-tenancy.</p>
        </li>
       </ul>
      </div>
      <div class="olist arabic">
       <div class="title">Procedure</div>
       <ol class="arabic">
        <li>
         <p>Configure a <code>MultiTenant</code> type filter.</p>
         <div class="listingblock">
          <div class="content">
           <pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">filterDefinitions</span>:
  - <span class="string"><span class="content">name: my-multi-tenant-filter</span></span>
    <span class="key">type</span>: <span class="string"><span class="content">MultiTenant</span></span>
    <span class="key">config</span>:
      <span class="key">prefixResourceNameSeparator</span>: <span class="string"><span class="delimiter">"</span><span class="content">.</span><span class="delimiter">"</span></span> <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
          </div>
         </div>
         <div class="colist arabic">
          <table>
           <tbody>
            <tr>
             <td><i class="conum" data-value="1"></i><b>1</b></td>
             <td>The separator used for the prefix. If a separator is not specified, <code>-</code> is the default.
              <div class="admonitionblock note">
               <table>
                <tbody>
                 <tr>
                  <td class="icon"><i class="fa icon-note" title="Note"></i></td>
                  <td class="content">Currently, only the prefix with separator is validated.</td>
                 </tr>
                </tbody>
               </table>
              </div></td>
            </tr>
           </tbody>
          </table>
         </div>
        </li>
        <li>
         <p>Verify that multi-tenancy filtering has been applied.</p>
         <div class="paragraph">
          <p>For example, create a topic through each virtual cluster and check that the topics are prefixed with the name of the corresponding virtual cluster.</p>
         </div>
         <div class="paragraph">
          <p>For more information, see the <a href="https://github.com/kroxylicious/kroxylicious/blob/main/kubernetes-examples/filters/multi-tenant/script.txt">example for a Kubernetes environment</a>.</p>
         </div>
        </li>
       </ol>
      </div>
     </div>
    </div>
    <div class="sect2">
     <h3 id="assembly-record-validation-filter-proxy">3.3. (Preview) Record Validation filter</h3>
     <div class="paragraph _abstract">
      <p>The Record Validation filter validates records sent by a producer. Only records that pass the validation are sent to the broker. This filter can be used to prevent <em>poison messages</em>—such as those containing corrupted data or invalid formats—from entering the Kafka system, which may otherwise lead to consumer failure.</p>
     </div>
     <div class="paragraph">
      <p>The filter currently supports two modes of operation:</p>
     </div>
     <div class="olist arabic">
      <ol class="arabic">
       <li>
        <p>Schema Validation ensures the content of the record conforms to a schema stored in an <a href="https://www.apicur.io/registry/">Apicurio Registry</a>.</p>
       </li>
       <li>
        <p>JSON Syntax Validation ensures the content of the record contains syntactically valid JSON.</p>
       </li>
      </ol>
     </div>
     <div class="paragraph">
      <p>Validation rules can be applied to check the content of the Kafka record key or value.</p>
     </div>
     <div class="paragraph">
      <p>If the validation fails, the product request is rejected and the producing application receives an error response. The broker will not receive the rejected records.</p>
     </div>
     <div class="admonitionblock note">
      <table>
       <tbody>
        <tr>
         <td class="icon"><i class="fa icon-note" title="Note"></i></td>
         <td class="content">This filter is currently in incubation and available as a preview. We would not recommend using it in a production environment.</td>
        </tr>
       </tbody>
      </table>
     </div>
     <div class="sect3">
      <h4 id="proc-record-validation-proxy">3.3.1. (Preview) Setting up the Record Validation filter</h4>
      <div class="paragraph _abstract">
       <p>This procedure describes how to set up the Record Validation filter. Provide the filter configuration and rules that the filter uses to check against Kafka record keys and values.</p>
      </div>
      <div class="ulist">
       <div class="title">Prerequisites</div>
       <ul>
        <li>
         <p>An instance of Kroxylicious. For information on deploying Kroxylicious, see the <a href="https://github.com/kroxylicious/kroxylicious" target="_blank" rel="noopener">samples and examples</a>.</p>
        </li>
        <li>
         <p>A config map for Kroxylicious that includes the configuration for creating a virtual cluster.</p>
        </li>
        <li>
         <p>Apicurio Registry (if wanting to use Schema validation).</p>
        </li>
       </ul>
      </div>
      <div class="olist arabic">
       <div class="title">Procedure</div>
       <ol class="arabic">
        <li>
         <p>Configure a <code>RecordValidation</code> type filter.</p>
        </li>
       </ol>
      </div>
      <div class="listingblock">
       <div class="content">
        <pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">filterDefinitions</span>:
  - <span class="string"><span class="content">name: my-record-validation</span></span>
    <span class="key">type</span>: <span class="string"><span class="content">RecordValidation</span></span>
    <span class="key">config</span>:
        <span class="key">rules</span>:
        - <span class="string"><span class="content">topicNames:                                                  </span><span class="content"><i class="conum" data-value="1"></i><b>(1)</b>
            - &lt;topic name&gt;</span></span>
          <span class="key">keyRule</span>:
            <span class="error">&lt;rule definition&gt;                                          </span><i class="conum" data-value="2"></i><b>(2)</b>
          <span class="key">valueRule</span>:
            <span class="error">&lt;rule definition&gt;                                          </span><i class="conum" data-value="3"></i><b>(3)</b>
        <span class="key">defaultRule</span>:                                                   <i class="conum" data-value="4"></i><b>(4)</b>
          <span class="key">keyRule</span>:
            <span class="error">&lt;rule definition&gt;                                          </span><i class="conum" data-value="2"></i><b>(2)</b>
          <span class="key">valueRule</span>:
            <span class="error">&lt;rule definition&gt;                                          </span><i class="conum" data-value="3"></i><b>(3)</b></code></pre>
       </div>
      </div>
      <div class="colist arabic">
       <table>
        <tbody>
         <tr>
          <td><i class="conum" data-value="1"></i><b>1</b></td>
          <td>List of topic names to which the validation rules will be applied.</td>
         </tr>
         <tr>
          <td><i class="conum" data-value="2"></i><b>2</b></td>
          <td>Validation rules that are applied to the record’s key.</td>
         </tr>
         <tr>
          <td><i class="conum" data-value="3"></i><b>3</b></td>
          <td>Validation rules that are applied to the record’s value.</td>
         </tr>
         <tr>
          <td><i class="conum" data-value="4"></i><b>4</b></td>
          <td>(Optional) Default rule that is applied to any topics for which there is no explict rule defined.</td>
         </tr>
        </tbody>
       </table>
      </div>
      <div class="paragraph">
       <p>Replace the token <code>&lt;rule definition&gt;</code> in the YAML configuration with either a Schema Validation rule or a JSON Syntax Validation rule depending on your requirements.</p>
      </div>
      <div class="paragraph">
       <div class="title">Example Schema Validation Rule Definition</div>
       <p>The Schema Validation rule validates that the key or value matches a schema identified by its global ID within an Apicurio Schema Registry.</p>
      </div>
      <div class="paragraph">
       <p>If the key or value does not adhere to the schema, the record will be rejected.</p>
      </div>
      <div class="paragraph">
       <p>Additionally, if the kafka producer has embedded a global ID within the record it will be validated against the global ID defined by the rule. If they do not match, the record will be rejected. See the <a href="https://www.apicur.io/registry/docs/apicurio-registry/2.6.x//getting-started/assembly-using-kafka-client-serdes.html#_consumer_schema_configuration" target="_blank" rel="noopener">Apicurio documentation</a> for details on how the global ID could be embedded into the record. The filter supports extracting ID’s from either the Apicurio <code>globalId</code> record header or from the initial bytes of the serialized content itself.</p>
      </div>
      <div class="listingblock">
       <div class="content">
        <pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">schemaValidationConfig</span>:
    <span class="key">apicurioGlobalId</span>: <span class="string"><span class="content">1001                                       </span></span><i class="conum" data-value="1"></i><b>(1)</b>
    <span class="key">apicurioRegistryUrl</span>: <span class="string"><span class="content">http://registry.local:8080              </span></span><i class="conum" data-value="2"></i><b>(2)</b>
<span class="key">allowNulls</span>: <span class="string"><span class="content">true                                                 </span></span><i class="conum" data-value="3"></i><b>(3)</b>
<span class="key">allowEmpty</span>: <span class="string"><span class="content">true                                                 </span></span><i class="conum" data-value="4"></i><b>(4)</b></code></pre>
       </div>
      </div>
      <div class="colist arabic">
       <table>
        <tbody>
         <tr>
          <td><i class="conum" data-value="1"></i><b>1</b></td>
          <td>Apicurio registry global ID identifying the schema that will be enforced.</td>
         </tr>
         <tr>
          <td><i class="conum" data-value="2"></i><b>2</b></td>
          <td>Apicurio Registry endpoint.</td>
         </tr>
         <tr>
          <td><i class="conum" data-value="3"></i><b>3</b></td>
          <td>if <code>true</code>, the validator allows keys and or values to be <code>null</code>. The default is <code>false</code>.</td>
         </tr>
         <tr>
          <td><i class="conum" data-value="4"></i><b>4</b></td>
          <td>if <code>true</code>, the validator allows keys and or values to be empty. The default is <code>false</code>.</td>
         </tr>
        </tbody>
       </table>
      </div>
      <div class="admonitionblock note">
       <table>
        <tbody>
         <tr>
          <td class="icon"><i class="fa icon-note" title="Note"></i></td>
          <td class="content">Schema validation mode currently has the capability to enforce only JSON schemas (<a href="https://github.com/kroxylicious/kroxylicious/issues/1431">issue</a>)</td>
         </tr>
        </tbody>
       </table>
      </div>
      <div class="paragraph">
       <div class="title">Example JSON Syntax Validation Rule Definition</div>
       <p>The JSON Syntax Validation rule validates that the key or value contains only syntactically correct JSON.</p>
      </div>
      <div class="listingblock">
       <div class="content">
        <pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">syntacticallyCorrectJson</span>:
    <span class="key">validateObjectKeysUnique</span>: <span class="string"><span class="content">true                               </span></span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="key">allowNulls</span>: <span class="string"><span class="content">true                                                 </span></span><i class="conum" data-value="2"></i><b>(2)</b>
<span class="key">allowEmpty</span>: <span class="string"><span class="content">true                                                 </span></span><i class="conum" data-value="3"></i><b>(3)</b></code></pre>
       </div>
      </div>
      <div class="colist arabic">
       <table>
        <tbody>
         <tr>
          <td><i class="conum" data-value="1"></i><b>1</b></td>
          <td>If <code>true</code>, the validator enforces that objects keys must be unique. The default is <code>false</code>.</td>
         </tr>
         <tr>
          <td><i class="conum" data-value="2"></i><b>2</b></td>
          <td>if <code>true</code>, the validator allows keys and or values to be <code>null</code>. The default is <code>false</code>.</td>
         </tr>
         <tr>
          <td><i class="conum" data-value="3"></i><b>3</b></td>
          <td>if <code>true</code>, the validator allows keys and or values to be empty. The default is <code>false</code>.</td>
         </tr>
        </tbody>
       </table>
      </div>
     </div>
    </div>
    <div class="sect2">
     <h3 id="con-oauthbearer-proxy">3.4. OAUTHBEARER validation</h3>
     <div class="paragraph _abstract">
      <p>OauthBearerValidation filter enables a validation on the JWT token received from client before forwarding it to cluster.</p>
     </div>
     <div class="paragraph">
      <p>If the token is not validated, then the request is short-circuited. It reduces resource consumption on the cluster when a client sends too many invalid SASL requests.</p>
     </div>
     <div class="imageblock">
      <div class="content">
       <img src="../images/diag-a2s-md5-249c81a210f34471fa61893011940858.svg" alt="Diagram" width="819" height="816">
      </div>
     </div>
     <div class="sect3">
      <h4 id="how_to_use_the_filter">3.4.1. How to use the filter</h4>
      <div class="paragraph">
       <p>There are two steps to using the filter.</p>
      </div>
      <div class="olist arabic">
       <ol class="arabic">
        <li>
         <p><a href="#con-configuring-virtual-clusters-proxy">Configuring virtual clusters</a></p>
        </li>
        <li>
         <p>Configuring the filter within Kroxylicious.</p>
        </li>
       </ol>
      </div>
      <div class="sect4">
       <h5 id="configuring_the_filter_within_kroxylicious">Configuring the filter within Kroxylicious.</h5>
       <div class="listingblock">
        <div class="content">
         <pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">filterDefinitions</span>:
  - <span class="string"><span class="content">name: my-oauth-filter</span></span>
    <span class="key">type</span>: <span class="string"><span class="content">OauthBearerValidation</span></span>
    <span class="key">config</span>:
      <span class="key">jwksEndpointUrl</span>: <span class="string"><span class="content">https://oauth/JWKS   </span></span><i class="conum" data-value="1"></i><b>(1)</b>
      <span class="key">jwksEndpointRefreshMs</span>: <span class="string"><span class="content">3600000        </span></span><i class="conum" data-value="2"></i><b>(2)</b>
      <span class="key">jwksEndpointRetryBackoffMs</span>: <span class="string"><span class="content">100       </span></span><i class="conum" data-value="3"></i><b>(3)</b>
      <span class="key">jwksEndpointRetryBackoffMaxMs</span>: <span class="string"><span class="content">10000  </span></span><i class="conum" data-value="4"></i><b>(4)</b>
      <span class="key">scopeClaimName</span>: <span class="string"><span class="content">scope                 </span></span><i class="conum" data-value="5"></i><b>(5)</b>
      <span class="key">subClaimName</span>: <span class="string"><span class="content">sub                     </span></span><i class="conum" data-value="6"></i><b>(6)</b>
      <span class="key">authenticateBackOffMaxMs</span>: <span class="string"><span class="content">60000       </span></span><i class="conum" data-value="7"></i><b>(7)</b>
      <span class="key">authenticateCacheMaxSize</span>: <span class="string"><span class="content">1000        </span></span><i class="conum" data-value="8"></i><b>(8)</b>
      <span class="key">expectedAudience</span>: <span class="string"><span class="content">https://first.audience, https//second.audience </span></span><i class="conum" data-value="9"></i><b>(9)</b>
      <span class="key">expectedIssuer</span>: <span class="string"><span class="content">https://your-domain.auth/ </span></span><i class="conum" data-value="10"></i><b>(10)</b></code></pre>
        </div>
       </div>
       <div class="colist arabic">
        <table>
         <tbody>
          <tr>
           <td><i class="conum" data-value="1"></i><b>1</b></td>
           <td>The OAuth/OIDC provider URL from which the provider’s JWKS (JSON Web Key Set) can be retrieved.</td>
          </tr>
          <tr>
           <td><i class="conum" data-value="2"></i><b>2</b></td>
           <td>The (optional) value in milliseconds for the broker to wait between refreshing its JWKS (JSON Web Key Set) cache that contains the keys to verify the signature of the JWT.</td>
          </tr>
          <tr>
           <td><i class="conum" data-value="3"></i><b>3</b></td>
           <td>The (optional) value in milliseconds for the initial wait between JWKS (JSON Web Key Set) retrieval attempts from the external authentication provider.</td>
          </tr>
          <tr>
           <td><i class="conum" data-value="4"></i><b>4</b></td>
           <td>The (optional) value in milliseconds for the maximum wait between attempts to retrieve the JWKS (JSON Web Key Set) from the external authentication provider.</td>
          </tr>
          <tr>
           <td><i class="conum" data-value="5"></i><b>5</b></td>
           <td>This (optional) setting can provide a different name to use for the scope included in the JWT payload’s claims.</td>
          </tr>
          <tr>
           <td><i class="conum" data-value="6"></i><b>6</b></td>
           <td>This (optional) setting can provide a different name to use for the subject included in the JWT payload’s claims.</td>
          </tr>
          <tr>
           <td><i class="conum" data-value="7"></i><b>7</b></td>
           <td>The (optional) maximum value in milliseconds to limit the client sending authenticate request. Setting 0 will never limit the client. Otherwise, an exponential delay is added to each authenticate request until the authenticateBackOffMaxMs has been reached.</td>
          </tr>
          <tr>
           <td><i class="conum" data-value="8"></i><b>8</b></td>
           <td>The (optional) maximum number of failed tokens kept in cache.</td>
          </tr>
          <tr>
           <td><i class="conum" data-value="9"></i><b>9</b></td>
           <td>The (optional) comma-delimited setting for the broker to use to verify that the JWT was issued for one of the expected audiences.</td>
          </tr>
          <tr>
           <td><i class="conum" data-value="10"></i><b>10</b></td>
           <td>The (optional) setting for the broker to use to verify that the JWT was created by the expected issuer.</td>
          </tr>
         </tbody>
        </table>
       </div>
       <div class="paragraph">
        <p>Note: OauthBearer config follows <a href="https://kafka.apache.org/documentation/#security_ssl">kafka’s properties</a></p>
       </div>
      </div>
     </div>
    </div>
   </div>
  </div>
  <div class="sect1">
   <h2 id="con-community-filters-proxy">4. Community filters</h2>
   <div class="sectionbody">
    <div class="paragraph _abstract">
     <p>Community contributed filters are showcased in the <a href="https://github.com/kroxylicious/kroxylicious-community-gallery" target="_blank" rel="noopener">Community Gallery</a>.</p>
    </div>
    <div class="admonitionblock note">
     <table>
      <tbody>
       <tr>
        <td class="icon"><i class="fa icon-note" title="Note"></i></td>
        <td class="content">These filters are contributed by the community and are not managed or maintained by the Kroxylicious team. Use them at your own risk.</td>
       </tr>
      </tbody>
     </table>
    </div>
   </div>
  </div>
  <div class="sect1">
   <h2 id="assembly-proxy-monitoring-proxy">5. Monitoring proxies</h2>
   <div class="sectionbody">
    <div class="paragraph _abstract">
     <p>Kroxylicious supports key observability features to help you understand the performance and health of your proxy instances.</p>
    </div>
    <div class="paragraph">
     <p>The Kroxylicious Proxy supports real-time monitoring and alerting by emitting system metrics. You can configure metric emission within the proxy and integrate it with a monitoring system like Prometheus to ingest and analyze the data.</p>
    </div>
    <div class="paragraph">
     <p>The Kroxylicious Proxy writes a log so that its actions may be understood over time. You can adjust log levels and customize logging as described in this section.</p>
    </div>
    <div class="sect2">
     <h3 id="proc-proxy-introducing-metrics-proxy">5.1. Introducing metrics</h3>
     <div class="paragraph _abstract">
      <p>If you want to introduce metrics to your Kroxylicious deployment, you can configure an insecure HTTP and Prometheus endpoint (at <code>/metrics</code>).</p>
     </div>
     <div class="paragraph">
      <p>Add the following to the <code>ConfigMap</code> resource that defines the Kroxylicious configuration:</p>
     </div>
     <div class="listingblock">
      <div class="title">Minimal metrics configuration</div>
      <div class="content">
       <pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">management</span>:
  <span class="key">endpoints</span>:
    <span class="key">prometheus</span>: <span class="string"><span class="content">{}</span></span></code></pre>
      </div>
     </div>
     <div class="paragraph">
      <p>By default, the HTTP endpoint listens on <code>0.0.0.0:9190</code>. You can change the bind address and port as follows:</p>
     </div>
     <div class="listingblock">
      <div class="title">Example metrics configuration with bind address and port</div>
      <div class="content">
       <pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">management</span>:
  <span class="key">bindAddress</span>: <span class="string"><span class="content">127.0.0.1</span></span>
  <span class="key">port</span>: <span class="string"><span class="content">9999</span></span>
  <span class="key">endpoints</span>:
    <span class="key">prometheus</span>: <span class="string"><span class="content">{}</span></span></code></pre>
      </div>
     </div>
    </div>
    <div class="sect2">
     <h3 id="con-prometheus-metrics-proxy-proxy">5.2. Overview of proxy metrics</h3>
     <div class="paragraph _abstract">
      <p>The proxy provides metrics for both connections and messages. These metrics are categorized into downstream (client-side) and upstream (broker-side) groups They allow users to assess the impact of the proxy and its filters on their Kafka system.</p>
     </div>
     <div class="ulist">
      <ul>
       <li>
        <p>Connection metrics count the connections made from the downstream (incoming connections from the clients) and the connection made by the proxy to upstream (outgoing connections to the Kafka brokers).</p>
       </li>
       <li>
        <p>Message metrics count the number of <a href="https://kafka.apache.org/protocol.html#protocol_messages">Kafka protocol request and response messages</a> that flow through the proxy.</p>
       </li>
      </ul>
     </div>
     <div class="sect3">
      <h4 id="connection_metrics">5.2.1. Connection metrics</h4>
      <div class="paragraph">
       <p>Connection metrics count the TCP connections made from the client to the proxy (<code>kroxylicious_client_to_proxy_request_total</code>) and from the proxy to the broker (<code>kroxylicious_proxy_to_server_connections_total</code>). These metrics count connection <em>attempts</em>, so the connection count is incremented even if the connection attempt ultimately fails.</p>
      </div>
      <div class="paragraph">
       <p>In addition to the count metrics, there are error metrics. * If an error occurs whilst the proxy is accepting a connection from the client the <code>kroxylicious_client_to_proxy_errors_total</code> metric is incremented by one. * If an error occurs whilst the proxy is attempting a connection to a broker the <code>kroxylicious_proxy_to_server_errors_total</code> metric is incremented by one.</p>
      </div>
      <div class="paragraph">
       <p>Connection and connection error metrics include the following labels: <code>virtual_cluster</code> (the virtual cluster’s name) and <code>node_id</code> (the broker’s node ID). When the client connects to the boostrap endpoint of the virtual cluster, a node ID value of <code>bootstrap</code> is recorded.</p>
      </div>
      <div class="paragraph">
       <p>The <code>kroxylicious_client_to_proxy_errors_total</code> metric also counts connection errors that occur before a virtual cluster has been identified. For these specific errors, the <code>virtual_cluster</code> and <code>node_id</code> labels are set to an empty string ("").</p>
      </div>
      <div class="admonitionblock note">
       <table>
        <tbody>
         <tr>
          <td class="icon"><i class="fa icon-note" title="Note"></i></td>
          <td class="content">Error conditions signaled <em>within</em> the Kafka protocol response (such as <code>RESOURCE_NOT_FOUND</code> or <code>UNKNOWN_TOPIC_ID</code>) are not classed as errors by these metrics.</td>
         </tr>
        </tbody>
       </table>
      </div>
      <table class="tableblock frame-all grid-all stretch">
       <caption class="title">Table 1. Connection metrics for client and broker interactions</caption>
       <colgroup>
        <col style="width: 25%;">
        <col style="width: 25%;">
        <col style="width: 25%;">
        <col style="width: 25%;">
       </colgroup>
       <thead>
        <tr>
         <th class="tableblock halign-left valign-top">Metric Name</th>
         <th class="tableblock halign-left valign-top">Type</th>
         <th class="tableblock halign-left valign-top">Labels</th>
         <th class="tableblock halign-left valign-top">Description</th>
        </tr>
       </thead>
       <tbody>
        <tr>
         <td class="tableblock halign-left valign-top">
          <p class="tableblock"><code>kroxylicious_client_to_proxy_connection_total</code></p>
         </td>
         <td class="tableblock halign-left valign-top">
          <p class="tableblock">Counter</p>
         </td>
         <td class="tableblock halign-left valign-top">
          <p class="tableblock"><code>virtual_cluster</code>, <code>node_id</code></p>
         </td>
         <td class="tableblock halign-left valign-top">
          <p class="tableblock">Incremented by one every time a connection is accepted from a client by the proxy.
           <br>
           This metric counts all connection attempts that reach the proxy, even those that end in error.</p>
         </td>
        </tr>
        <tr>
         <td class="tableblock halign-left valign-top">
          <p class="tableblock"><code>kroxylicious_client_to_proxy_errors_total</code></p>
         </td>
         <td class="tableblock halign-left valign-top">
          <p class="tableblock">Counter</p>
         </td>
         <td class="tableblock halign-left valign-top">
          <p class="tableblock"><code>virtual_cluster</code>, <code>node_id</code></p>
         </td>
         <td class="tableblock halign-left valign-top">
          <p class="tableblock">Incremented by one every time a connection is closed due to any downstream error.</p>
         </td>
        </tr>
        <tr>
         <td class="tableblock halign-left valign-top">
          <p class="tableblock"><code>kroxylicious_proxy_to_server_connections_total</code></p>
         </td>
         <td class="tableblock halign-left valign-top">
          <p class="tableblock">Counter</p>
         </td>
         <td class="tableblock halign-left valign-top">
          <p class="tableblock"><code>virtual_cluster</code>, <code>node_id</code></p>
         </td>
         <td class="tableblock halign-left valign-top">
          <p class="tableblock">Incremented by one every time a connection is made to the server from the proxy.
           <br>
           This metric counts all connections attempted to the broker, even those that end in error.</p>
         </td>
        </tr>
        <tr>
         <td class="tableblock halign-left valign-top">
          <p class="tableblock"><code>kroxylicious_proxy_to_server_errors_total</code></p>
         </td>
         <td class="tableblock halign-left valign-top">
          <p class="tableblock">Counter</p>
         </td>
         <td class="tableblock halign-left valign-top">
          <p class="tableblock"><code>virtual_cluster</code>, <code>node_id</code></p>
         </td>
         <td class="tableblock halign-left valign-top">
          <p class="tableblock">Incremented by one every time a connection is closed due to any upstream error.</p>
         </td>
        </tr>
       </tbody>
      </table>
     </div>
     <div class="sect3">
      <h4 id="message_metrics">5.2.2. Message metrics</h4>
      <div class="paragraph">
       <p>Message metrics count, and record the sizes of, the Kafka protocol requests and responses that flow through the proxy.</p>
      </div>
      <div class="paragraph">
       <p>Use these metrics to help understand: * the number of messages flowing through the proxy. * the overall volume of data through the proxy. * the effect the filters are having on the messages.</p>
      </div>
      <div class="ulist">
       <ul>
        <li>
         <p>Downstream metrics</p>
         <div class="ulist">
          <ul>
           <li>
            <p><code>kroxylicious_client_to_proxy_request_total</code> counts requests as they arrive from the client.</p>
           </li>
           <li>
            <p><code>kroxylicious_proxy_to_client_response_total</code> counts responses as they are returned to the client.</p>
           </li>
           <li>
            <p><code>kroxylicious_client_to_proxy_request_size_bytes</code> is incremented by the size of each request as it arrives from the client.</p>
           </li>
           <li>
            <p><code>kroxylicious_proxy_to_client_response_size_bytes</code> is incremented by the size of each response as it is returned to the client.</p>
           </li>
          </ul>
         </div>
        </li>
        <li>
         <p>Upstream metrics</p>
         <div class="ulist">
          <ul>
           <li>
            <p><code>kroxylicious_proxy_to_server_request_total</code> counts requests as they go to the broker.</p>
           </li>
           <li>
            <p><code>kroxylicious_proxy_to_server_response_total</code> counts responses as they are returned by the broker.</p>
           </li>
           <li>
            <p><code>kroxylicious_proxy_to_server_request_size_bytes</code> is incremented by the size of each request as it goes to the broker.</p>
           </li>
           <li>
            <p><code>kroxylicious_proxy_to_server_response_size_bytes</code> is incremented by the size of each response as it is returned by the broker.</p>
           </li>
          </ul>
         </div>
        </li>
       </ul>
      </div>
      <div class="paragraph">
       <p>The size recorded is the encoded size of the protocol message. It includes the 4 byte <a href="https://kafka.apache.org/protocol.html#protocol_common">message size</a>.</p>
      </div>
      <div class="paragraph">
       <p>Filters can alter the flow of messages through the proxy or the content of the message. This is apparent through the metrics. * If a filter sends a short-circuit, or closes a connection the downstream message counters will exceed the upstream counters. * If a filter changes the size of the message, the downstream size metrics will be different to the upstream size metrics.</p>
      </div>
      <div class="imageblock">
       <div class="content">
        <img src="../images/monitoring-message-counters.svg" alt="Conceptual diagram showing the downstream and upstream message metrics within the proxy, illustrating how they respond to message transit through it.">
       </div>
       <div class="title">Figure 5. Downstream and upstream message metrics in the proxy</div>
      </div>
      <div class="paragraph">
       <p>Message metrics include the following labels: <code>virtual_cluster</code> (the virtual cluster’s name), <code>node_id</code> (the broker’s node ID), <code>api_key</code> (the message type), <code>api_version</code>, and <code>decoded</code> (a flag indicating if the message was decoded by the proxy).</p>
      </div>
      <div class="paragraph">
       <p>When the client connects to the boostrap endpoint of the virtual cluster, metrics are recorded with a node ID value of <code>bootstrap</code>.</p>
      </div>
      <table class="tableblock frame-all grid-all stretch">
       <caption class="title">Table 2. Kafka message metrics for proxy request and response flow</caption>
       <colgroup>
        <col style="width: 25%;">
        <col style="width: 25%;">
        <col style="width: 25%;">
        <col style="width: 25%;">
       </colgroup>
       <thead>
        <tr>
         <th class="tableblock halign-left valign-top">Metric Name</th>
         <th class="tableblock halign-left valign-top">Type</th>
         <th class="tableblock halign-left valign-top">Labels</th>
         <th class="tableblock halign-left valign-top">Description</th>
        </tr>
       </thead>
       <tbody>
        <tr>
         <td class="tableblock halign-left valign-top">
          <p class="tableblock"><code>kroxylicious_client_to_proxy_request_total</code></p>
         </td>
         <td class="tableblock halign-left valign-top">
          <p class="tableblock">Counter</p>
         </td>
         <td class="tableblock halign-left valign-top">
          <p class="tableblock"><code>virtual_cluster</code>, <code>node_id</code>, <code>api_key</code>, <code>api_version</code>, <code>decoded</code></p>
         </td>
         <td class="tableblock halign-left valign-top">
          <p class="tableblock">Incremented by one every time a request arrives at the proxy from a client.</p>
         </td>
        </tr>
        <tr>
         <td class="tableblock halign-left valign-top">
          <p class="tableblock"><code>kroxylicious_proxy_to_server_request_total</code></p>
         </td>
         <td class="tableblock halign-left valign-top">
          <p class="tableblock">Counter</p>
         </td>
         <td class="tableblock halign-left valign-top">
          <p class="tableblock"><code>virtual_cluster</code>, <code>node_id</code>, <code>api_key</code>, <code>api_version</code>, <code>decoded</code></p>
         </td>
         <td class="tableblock halign-left valign-top">
          <p class="tableblock">Incremented by one every time a request goes from the proxy to a server.</p>
         </td>
        </tr>
        <tr>
         <td class="tableblock halign-left valign-top">
          <p class="tableblock"><code>kroxylicious_server_to_proxy_response_total</code></p>
         </td>
         <td class="tableblock halign-left valign-top">
          <p class="tableblock">Counter</p>
         </td>
         <td class="tableblock halign-left valign-top">
          <p class="tableblock"><code>virtual_cluster</code>, <code>node_id</code>, <code>api_key</code>, <code>api_version</code>, <code>decoded</code></p>
         </td>
         <td class="tableblock halign-left valign-top">
          <p class="tableblock">Incremented by one every time a response arrives at the proxy from a server.</p>
         </td>
        </tr>
        <tr>
         <td class="tableblock halign-left valign-top">
          <p class="tableblock"><code>kroxylicious_proxy_to_client_response_total</code></p>
         </td>
         <td class="tableblock halign-left valign-top">
          <p class="tableblock">Counter</p>
         </td>
         <td class="tableblock halign-left valign-top">
          <p class="tableblock"><code>virtual_cluster</code>, <code>node_id</code>, <code>api_key</code>, <code>api_version</code>, <code>decoded</code></p>
         </td>
         <td class="tableblock halign-left valign-top">
          <p class="tableblock">Incremented by one every time a response goes from the proxy to a client.</p>
         </td>
        </tr>
        <tr>
         <td class="tableblock halign-left valign-top">
          <p class="tableblock"><code>kroxylicious_client_to_proxy_request_total</code></p>
         </td>
         <td class="tableblock halign-left valign-top">
          <p class="tableblock">Distribution</p>
         </td>
         <td class="tableblock halign-left valign-top">
          <p class="tableblock"><code>virtual_cluster</code>, <code>node_id</code>, <code>api_key</code>, <code>api_version</code>, <code>decoded</code></p>
         </td>
         <td class="tableblock halign-left valign-top">
          <p class="tableblock">Incremented by the size of the message each time a request arrives at the proxy from a client.</p>
         </td>
        </tr>
        <tr>
         <td class="tableblock halign-left valign-top">
          <p class="tableblock"><code>kroxylicious_proxy_to_server_request_total</code></p>
         </td>
         <td class="tableblock halign-left valign-top">
          <p class="tableblock">Distribution</p>
         </td>
         <td class="tableblock halign-left valign-top">
          <p class="tableblock"><code>virtual_cluster</code>, <code>node_id</code>, <code>api_key</code>, <code>api_version</code>, <code>decoded</code></p>
         </td>
         <td class="tableblock halign-left valign-top">
          <p class="tableblock">Incremented by the size of the message each time a request goes from the proxy to a server.</p>
         </td>
        </tr>
        <tr>
         <td class="tableblock halign-left valign-top">
          <p class="tableblock"><code>kroxylicious_server_to_proxy_response_total</code></p>
         </td>
         <td class="tableblock halign-left valign-top">
          <p class="tableblock">Distribution</p>
         </td>
         <td class="tableblock halign-left valign-top">
          <p class="tableblock"><code>virtual_cluster</code>, <code>node_id</code>, <code>api_key</code>, <code>api_version</code>, <code>decoded</code></p>
         </td>
         <td class="tableblock halign-left valign-top">
          <p class="tableblock">Incremented by the size of the message each time a response arrives at the proxy from a server.</p>
         </td>
        </tr>
        <tr>
         <td class="tableblock halign-left valign-top">
          <p class="tableblock"><code>kroxylicious_proxy_to_client_response_total</code></p>
         </td>
         <td class="tableblock halign-left valign-top">
          <p class="tableblock">Distribution</p>
         </td>
         <td class="tableblock halign-left valign-top">
          <p class="tableblock"><code>virtual_cluster</code>, <code>node_id</code>, <code>api_key</code>, <code>api_version</code>, <code>decoded</code></p>
         </td>
         <td class="tableblock halign-left valign-top">
          <p class="tableblock">Incremented by the size of the message each time a response goes from the proxy to a client.</p>
         </td>
        </tr>
       </tbody>
      </table>
     </div>
    </div>
    <div class="sect2">
     <h3 id="con-proxy-ingesting-metrics-proxy">5.3. Ingesting metrics</h3>
     <div class="paragraph _abstract">
      <p>Metrics from the Kroxylicious Proxy can be ingested into your Prometheus instance.</p>
     </div>
     <div class="paragraph">
      <p>Configure the <a href="https://prometheus.io/docs/prometheus/latest/configuration/configuration/#scrape_config"><code>scrape_configs</code></a> property to enable Prometheus to scrape the monitors from your proxy instances.</p>
     </div>
     <div class="listingblock">
      <div class="title">Example Prometheus scrape config</div>
      <div class="content">
       <pre class="CodeRay highlight"><code>scrape_configs:
  - job_name: 'kroxylicious'
    static_configs:
      - targets: ['proxyhost:9190'] <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
      </div>
     </div>
     <div class="colist arabic">
      <table>
       <tbody>
        <tr>
         <td><i class="conum" data-value="1"></i><b>1</b></td>
         <td>The host that is running the kroxylicious instance and the port number assigned to management.</td>
        </tr>
       </tbody>
      </table>
     </div>
    </div>
    <div class="sect2">
     <h3 id="con-proxy-integrating-micrometer-proxy">5.4. Integrating Micrometer</h3>
     <div class="paragraph">
      <p>Kroxylicious integrates with <a href="https://micrometer.io/docs">Micrometer</a> for gathering metrics.</p>
     </div>
     <div class="paragraph">
      <p>Micrometer provides a simple facade over instrumentation clients for popular observability systems, allowing you to instrument your JVM-based application code without vendor lock-in. The following example shows how to define the <code>CommonTagsHook</code> and <code>StandardBindersHook</code> types to add a label to metrics and register a JVM metrics binder.</p>
     </div>
     <div class="listingblock">
      <div class="title">Example proxy configuration for Micrometer integration</div>
      <div class="content">
       <pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">management</span>:
  <span class="key">endpoints</span>:
    <span class="key">prometheus</span>: <span class="string"><span class="content">{}</span></span>
<span class="key">micrometer</span>:
  - <span class="string"><span class="content">type: "CommonTagsHook" </span></span><i class="conum" data-value="1"></i><b>(1)</b>
    <span class="key">config</span>:
      <span class="key">commonTags</span>:
        <span class="key">zone</span>: <span class="string"><span class="delimiter">"</span><span class="content">euc-1a</span><span class="delimiter">"</span></span> <i class="conum" data-value="2"></i><b>(2)</b>
  - <span class="string"><span class="content">type: "StandardBindersHook" </span></span><i class="conum" data-value="3"></i><b>(3)</b>
    <span class="key">config</span>:
      <span class="key">binderNames</span>:
      - <span class="string"><span class="delimiter">"</span><span class="content">JvmGcMetrics</span><span class="delimiter">"</span></span> <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
      </div>
     </div>
     <div class="colist arabic">
      <table>
       <tbody>
        <tr>
         <td><i class="conum" data-value="1"></i><b>1</b></td>
         <td>Specifies the <code>CommonTagsHook</code> type to add common tags to all metrics.</td>
        </tr>
        <tr>
         <td><i class="conum" data-value="2"></i><b>2</b></td>
         <td>Adds common tag zone <code>euc-1a</code> to all metrics in the global registry included with Micrometer, which appears as a label in Prometheus.</td>
        </tr>
        <tr>
         <td><i class="conum" data-value="3"></i><b>3</b></td>
         <td>Specifies the <code>StandardBindersHook</code> type to register standard Micrometer binders.</td>
        </tr>
        <tr>
         <td><i class="conum" data-value="4"></i><b>4</b></td>
         <td>Registers the <code>JvmGcMetrics</code> binder with the global registry.</td>
        </tr>
       </tbody>
      </table>
     </div>
     <div class="paragraph">
      <p>Prometheus is connected to the Micrometer global registry, so filters can record metrics against it as part of the Prometheus scrape data.</p>
     </div>
     <div class="paragraph">
      <p>Using the <code>curl localhost:9190/metrics</code> command shows metrics as follows:</p>
     </div>
     <div class="listingblock">
      <div class="title">Example metrics returned from request</div>
      <div class="content">
       <pre class="CodeRay highlight"><code data-lang="shell">jvm_gc_memory_allocated_bytes_total{zone="euc-1a",} 0.0</code></pre>
      </div>
     </div>
     <div class="sect3">
      <h4 id="common_tags">5.4.1. Common tags</h4>
      <div class="paragraph">
       <p>Add common tags for metrics to appear as labels in the Prometheus scrape.</p>
      </div>
      <div class="listingblock">
       <div class="title">Example common tag configuration</div>
       <div class="content">
        <pre class="CodeRay highlight"><code data-lang="yaml">- <span class="string"><span class="content">type: "CommonTagsHook"</span></span>
  <span class="key">config</span>:
    <span class="key">commonTags</span>:
      <span class="key">zone</span>: <span class="string"><span class="delimiter">"</span><span class="content">euc-1a</span><span class="delimiter">"</span></span>
      <span class="key">owner</span>: <span class="string"><span class="delimiter">"</span><span class="content">team-a</span><span class="delimiter">"</span></span></code></pre>
       </div>
      </div>
     </div>
     <div class="sect3">
      <h4 id="standard_binders">5.4.2. Standard binders</h4>
      <div class="paragraph">
       <p>Micrometer uses the concept of meter binders to register metrics that provide information about the state of some aspect of the application or its container. By registering standard binders included with Micrometer, you can expose metrics about the JVM and system, such as JVM memory usage and garbage collection.</p>
      </div>
      <div class="listingblock">
       <div class="title">Example binders configuration</div>
       <div class="content">
        <pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">micrometer</span>:
  - <span class="string"><span class="content">type: "StandardBindersHook"</span></span>
    <span class="key">config</span>:
      <span class="key">binderNames</span>:
      - <span class="string"><span class="delimiter">"</span><span class="content">JvmGcMetrics</span><span class="delimiter">"</span></span>
      - <span class="string"><span class="delimiter">"</span><span class="content">JvmHeapPressureMetrics</span><span class="delimiter">"</span></span></code></pre>
       </div>
      </div>
      <table class="tableblock frame-all grid-all stretch">
       <caption class="title">Table 3. Standard binders available with Micrometer</caption>
       <colgroup>
        <col style="width: 33.3333%;">
        <col style="width: 66.6667%;">
       </colgroup>
       <thead>
        <tr>
         <th class="tableblock halign-left valign-top">Name</th>
         <th class="tableblock halign-left valign-top">Micrometer class</th>
        </tr>
       </thead>
       <tbody>
        <tr>
         <td class="tableblock halign-left valign-top">
          <p class="tableblock"><code>ClassLoaderMetrics</code></p>
         </td>
         <td class="tableblock halign-left valign-top">
          <p class="tableblock"><code>io.micrometer.core.instrument.binder.jvm.ClassLoaderMetrics</code></p>
         </td>
        </tr>
        <tr>
         <td class="tableblock halign-left valign-top">
          <p class="tableblock"><code>JvmCompilationMetrics</code></p>
         </td>
         <td class="tableblock halign-left valign-top">
          <p class="tableblock"><code>io.micrometer.core.instrument.binder.jvm.JvmCompilationMetrics</code></p>
         </td>
        </tr>
        <tr>
         <td class="tableblock halign-left valign-top">
          <p class="tableblock"><code>JvmGcMetrics</code></p>
         </td>
         <td class="tableblock halign-left valign-top">
          <p class="tableblock"><code>io.micrometer.core.instrument.binder.jvm.JvmGcMetrics</code></p>
         </td>
        </tr>
        <tr>
         <td class="tableblock halign-left valign-top">
          <p class="tableblock"><code>JvmHeapPressureMetrics</code></p>
         </td>
         <td class="tableblock halign-left valign-top">
          <p class="tableblock"><code>io.micrometer.core.instrument.binder.jvm.JvmHeapPressureMetrics</code></p>
         </td>
        </tr>
        <tr>
         <td class="tableblock halign-left valign-top">
          <p class="tableblock"><code>JvmInfoMetrics</code></p>
         </td>
         <td class="tableblock halign-left valign-top">
          <p class="tableblock"><code>io.micrometer.core.instrument.binder.jvm.JvmInfoMetrics</code></p>
         </td>
        </tr>
        <tr>
         <td class="tableblock halign-left valign-top">
          <p class="tableblock"><code>JvmMemoryMetrics</code></p>
         </td>
         <td class="tableblock halign-left valign-top">
          <p class="tableblock"><code>io.micrometer.core.instrument.binder.jvm.JvmMemoryMetrics</code></p>
         </td>
        </tr>
        <tr>
         <td class="tableblock halign-left valign-top">
          <p class="tableblock"><code>JvmThreadMetrics</code></p>
         </td>
         <td class="tableblock halign-left valign-top">
          <p class="tableblock"><code>io.micrometer.core.instrument.binder.jvm.JvmThreadMetrics</code></p>
         </td>
        </tr>
        <tr>
         <td class="tableblock halign-left valign-top">
          <p class="tableblock"><code>FileDescriptorMetrics</code></p>
         </td>
         <td class="tableblock halign-left valign-top">
          <p class="tableblock"><code>io.micrometer.core.instrument.binder.system.FileDescriptorMetrics</code></p>
         </td>
        </tr>
        <tr>
         <td class="tableblock halign-left valign-top">
          <p class="tableblock"><code>ProcessorMetrics</code></p>
         </td>
         <td class="tableblock halign-left valign-top">
          <p class="tableblock"><code>io.micrometer.core.instrument.binder.system.ProcessorMetrics</code></p>
         </td>
        </tr>
        <tr>
         <td class="tableblock halign-left valign-top">
          <p class="tableblock"><code>UptimeMetrics</code></p>
         </td>
         <td class="tableblock halign-left valign-top">
          <p class="tableblock"><code>io.micrometer.core.instrument.binder.system.UptimeMetrics</code></p>
         </td>
        </tr>
       </tbody>
      </table>
     </div>
     <div class="sect3">
      <h4 id="using_micrometer_with_filters">5.4.3. Using Micrometer with filters</h4>
      <div class="paragraph">
       <p>Use the static methods of <a href="https://www.javadoc.io/doc/io.micrometer/micrometer-core/1.10.5/io/micrometer/core/instrument/Metrics.html" target="_blank" rel="noopener">Micrometer Metrics</a> to register metrics with the global registry.</p>
      </div>
      <div class="paragraph">
       <p>Alternatively, use <code>Metrics.globalRegistry</code> to get a reference to the global registry. Metrics registered this way are automatically available through the Prometheus scrape endpoint.</p>
      </div>
     </div>
    </div>
    <div class="sect2">
     <h3 id="proc-proxy-setting-log-levels-proxy">5.5. Setting log levels</h3>
     <div class="paragraph _abstract">
      <p>The Kroxylicious <a href="https://github.com/kroxylicious/kroxylicious/tree/main" target="_blank" rel="noopener">binary distribution</a> includes <a href="https://logging.apache.org/log4j/2.x">log4j2</a> as the default logging backend.</p>
     </div>
     <div class="paragraph">
      <p>When using the <code>bin/kroxylicious-start.sh</code> script from the binary distribution, you can set an environment variable to load a custom <code>log4j2</code> configuration file or change the root logging level.</p>
     </div>
     <div class="listingblock">
      <div class="title">
       Environment variable to load a custom <code>log4j2</code> file
      </div>
      <div class="content">
       <pre class="CodeRay highlight"><code data-lang="properties">KROXYLICIOUS_LOGGING_OPTIONS="-Dlog4j2.configurationFile=/path/to/custom/log4j2.yaml"</code></pre>
      </div>
     </div>
     <div class="listingblock">
      <div class="title">Environment variable to change the root logging level</div>
      <div class="content">
       <pre class="CodeRay highlight"><code data-lang="properties">KROXYLICIOUS_ROOT_LOG_LEVEL="DEBUG"</code></pre>
      </div>
     </div>
     <div class="admonitionblock note">
      <table>
       <tbody>
        <tr>
         <td class="icon"><i class="fa icon-note" title="Note"></i></td>
         <td class="content">Setting the root log level to <code>DEBUG</code> or <code>TRACE</code> will produce very verbose logs.</td>
        </tr>
       </tbody>
      </table>
     </div>
    </div>
   </div>
  </div>
  <div class="sect1">
   <h2 id="trademark_notice">6. Trademark notice</h2>
   <div class="sectionbody">
    <div class="ulist">
     <ul>
      <li>
       <p>Apache Kafka is a registered trademark of The Apache Software Foundation.</p>
      </li>
      <li>
       <p>Kubernetes is a registered trademark of The Linux Foundation.</p>
      </li>
      <li>
       <p>Prometheus is a registered trademark of The Linux Foundation.</p>
      </li>
      <li>
       <p>Strimzi is a trademark of The Linux Foundation.</p>
      </li>
      <li>
       <p>Hashicorp Vault is a registered trademark of HashiCorp, Inc.</p>
      </li>
      <li>
       <p>AWS Key Management Service is a trademark of Amazon.com, Inc. or its affiliates.</p>
      </li>
      <li>
       <p>Fortanix and Data Security Manager are trademarks of Fortanix, Inc.</p>
      </li>
     </ul>
    </div>
   </div>
  </div>
 </body>
</html>
{% endraw %}
